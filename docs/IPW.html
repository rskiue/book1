<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>chapter: 7 IPWや操作変数について | IPW</title>
  <meta name="description" content="This is a description. Please wrote a abstract this contents." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="chapter: 7 IPWや操作変数について | IPW" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a description. Please wrote a abstract this contents." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="chapter: 7 IPWや操作変数について | IPW" />
  
  <meta name="twitter:description" content="This is a description. Please wrote a abstract this contents." />
  

<meta name="author" content="author_name" />


<meta name="date" content="2022-05-25" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="heterogeneous-treatment-effect-1.html"/>

<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">サイト(書籍)タイトルいれてね</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> book_title</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#書籍作成方法"><i class="fa fa-check"></i><b>1.1</b> 書籍作成方法</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#必要なパッケージ環境など"><i class="fa fa-check"></i><b>1.1.1</b> 必要なパッケージ,環境など</a></li>
<li class="chapter" data-level="1.1.2" data-path="index.html"><a href="index.html#download"><i class="fa fa-check"></i><b>1.1.2</b> Download</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="01-title1.html"><a href="01-title1.html"><i class="fa fa-check"></i><b>2</b> メモ</a></li>
<li class="chapter" data-level="3" data-path="02-title2.html"><a href="02-title2.html"><i class="fa fa-check"></i><b>3</b> 章のタイトル2</a>
<ul>
<li class="chapter" data-level="3.1" data-path="02-title2.html"><a href="02-title2.html#節見出し1"><i class="fa fa-check"></i><b>3.1</b> 節見出し1</a></li>
<li class="chapter" data-level="3.2" data-path="02-title2.html"><a href="02-title2.html#節見出し2"><i class="fa fa-check"></i><b>3.2</b> 節見出し2</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="03-method.html"><a href="03-method.html"><i class="fa fa-check"></i><b>4</b> Methods</a>
<ul>
<li class="chapter" data-level="4.1" data-path="03-method.html"><a href="03-method.html#gmm"><i class="fa fa-check"></i><b>4.1</b> GMM</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="04-literature.html"><a href="04-literature.html"><i class="fa fa-check"></i><b>5</b> メモ</a>
<ul>
<li class="chapter" data-level="5.1" data-path="04-literature.html"><a href="04-literature.html#bookdown関連"><i class="fa fa-check"></i><b>5.1</b> Bookdown関連</a></li>
<li class="chapter" data-level="5.2" data-path="04-literature.html"><a href="04-literature.html#docker関連"><i class="fa fa-check"></i><b>5.2</b> Docker関連</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="04-literature.html"><a href="04-literature.html#参考情報"><i class="fa fa-check"></i><b>5.2.1</b> 参考情報</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="heterogeneous-treatment-effect-1.html"><a href="heterogeneous-treatment-effect-1.html"><i class="fa fa-check"></i><b>6</b> HTE I: Binary treatment</a>
<ul>
<li class="chapter" data-level="6.1" data-path="heterogeneous-treatment-effect-1.html"><a href="heterogeneous-treatment-effect-1.html#pre-specified-hypotheses"><i class="fa fa-check"></i><b>6.1</b> Pre-specified hypotheses</a></li>
<li class="chapter" data-level="6.2" data-path="heterogeneous-treatment-effect-1.html"><a href="heterogeneous-treatment-effect-1.html#data-driven-hypotheses"><i class="fa fa-check"></i><b>6.2</b> Data-driven hypotheses</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="heterogeneous-treatment-effect-1.html"><a href="heterogeneous-treatment-effect-1.html#via-causal-trees"><i class="fa fa-check"></i><b>6.2.1</b> Via causal trees</a></li>
<li class="chapter" data-level="6.2.2" data-path="heterogeneous-treatment-effect-1.html"><a href="heterogeneous-treatment-effect-1.html#via-grf"><i class="fa fa-check"></i><b>6.2.2</b> Via grf</a></li>
<li class="chapter" data-level="6.2.3" data-path="heterogeneous-treatment-effect-1.html"><a href="heterogeneous-treatment-effect-1.html#実際の活用におけるプロセス"><i class="fa fa-check"></i><b>6.2.3</b> 実際の活用におけるプロセス</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="heterogeneous-treatment-effect-1.html"><a href="heterogeneous-treatment-effect-1.html#further-reading"><i class="fa fa-check"></i><b>6.3</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="IPW.html"><a href="IPW.html"><i class="fa fa-check"></i><b>7</b> IPWや操作変数について</a>
<ul>
<li class="chapter" data-level="7.1" data-path="IPW.html"><a href="IPW.html#ipw"><i class="fa fa-check"></i><b>7.1</b> IPW</a></li>
<li class="chapter" data-level="7.2" data-path="IPW.html"><a href="IPW.html#操作変数的な変数を調整したときに起こるzバイアス"><i class="fa fa-check"></i><b>7.2</b> 操作変数的な変数を調整したときに起こるZバイアス</a></li>
<li class="chapter" data-level="7.3" data-path="IPW.html"><a href="IPW.html#直接効果と関節効果がある場合"><i class="fa fa-check"></i><b>7.3</b> 直接効果と関節効果がある場合</a></li>
<li class="chapter" data-level="7.4" data-path="IPW.html"><a href="IPW.html#処置の結果変数は操作変数になりうるか"><i class="fa fa-check"></i><b>7.4</b> 処置の結果変数は操作変数になりうるか？</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">IPW</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ipwや操作変数について" class="section level1" number="7">
<h1><span class="header-section-number">chapter: 7</span> IPWや操作変数について</h1>
<div id="ipw" class="section level2" number="7.1">
<h2><span class="header-section-number">7.1</span> IPW</h2>
<p>突然だがIPW推定量をここで見てみよう）</p>
<p>傾向スコアが高い人たちは処置を受けやすいと同時に、アウトカムも高くなりやすい。</p>
<p>だからInverse probabilityでウェイティングしようというアイデア。</p>
<p>Y1として、処置群におけるYの数を、増やすイメージ。例えば傾向スコアが0.3であればYが3倍に増える。（疑問：それでサンプル数と同じだけの人数になるのか？　すなわち、WY/eの期待値がY（W＝１）の期待値と一致するのか）処置軍において傾向スコアの逆数の和をとると、サンプルサイズになるというのは感覚的にわかる。傾向スコアが0.5なのであれば、実際にはその人数は倍ということなので。</p>
<p>(1/e)の処置群での和はサンプルサイズに等しくなる。</p>
<p>処置群において、処置群の人たちをバランスさせた上で、その人Nで割るのは、Horvitz-Thompson estimatorというらしい。</p>
<p>Hajek estimator</p>
<p>IPWの本質は Data augmentation だと思っているのですが、「観測データの個数 nではなく、実際にどのくらい augmentation したのかに相当する項で割った方がよさそう」という気持ちを感じます。 <a href="https://fullflu.hatenablog.com/entry/2020/05/01/ipw#Horvitz-Thompson-estimator-%E3%81%A8%E3%81%AF" class="uri">https://fullflu.hatenablog.com/entry/2020/05/01/ipw#Horvitz-Thompson-estimator-%E3%81%A8%E3%81%AF</a></p>
<p><span class="math display">\[
Y=aX+bW+\epsilon\\
p(W=1)=Normal(a+bX,\epsilon)\\
ATE=\frac{1}{N}\sum_{W_i=1}\frac{Y_i}{e(X_i)}-\frac{1}{N}\sum_{W_i=0}\frac{Y_i}{1-e(X_i)}\\
ATE=\frac{1}{\sum \frac{W_i}{e(X_i)}}\sum\frac{W_iY_i}{e(X_i)}- \frac{1}{\sum \frac{1-W_i}{1-e(X_i)}}\sum\frac{(1-W_i)Y_i}{1-e(X_i)}
\]</span></p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="IPW.html#cb71-1" aria-hidden="true" tabindex="-1"></a>xx<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">10000</span>)</span>
<span id="cb71-2"><a href="IPW.html#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="IPW.html#cb71-3" aria-hidden="true" tabindex="-1"></a>p<span class="ot">&lt;-</span><span class="fu">pnorm</span>(<span class="fl">0.2</span><span class="sc">+</span>xx)</span>
<span id="cb71-4"><a href="IPW.html#cb71-4" aria-hidden="true" tabindex="-1"></a>w<span class="ot">&lt;-</span><span class="fu">rbinom</span>(<span class="dv">10000</span>,<span class="dv">1</span>,p)</span>
<span id="cb71-5"><a href="IPW.html#cb71-5" aria-hidden="true" tabindex="-1"></a>yy<span class="ot">&lt;-</span><span class="dv">1</span><span class="fl">+0.5</span><span class="sc">*</span>xx<span class="fl">+0.8</span><span class="sc">*</span>w<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">10000</span>)</span>
<span id="cb71-6"><a href="IPW.html#cb71-6" aria-hidden="true" tabindex="-1"></a>dd<span class="ot">&lt;-</span><span class="fu">tibble</span>(xx,p,w,yy)</span>
<span id="cb71-7"><a href="IPW.html#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="IPW.html#cb71-8" aria-hidden="true" tabindex="-1"></a>model<span class="ot">&lt;-</span><span class="fu">glm</span>(w<span class="sc">~</span>xx,<span class="at">data=</span>dd,<span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">&quot;logit&quot;</span>))</span>
<span id="cb71-9"><a href="IPW.html#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="IPW.html#cb71-10" aria-hidden="true" tabindex="-1"></a>dd<span class="ot">&lt;-</span>dd <span class="sc">%&gt;%</span></span>
<span id="cb71-11"><a href="IPW.html#cb71-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e=</span>model<span class="sc">$</span>fitted.values)</span></code></pre></div>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="IPW.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(yy<span class="sc">~</span>xx<span class="sc">+</span>w,<span class="at">data=</span>dd) <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = yy ~ xx + w, data = dd)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.6044 -0.6749  0.0043  0.6858  3.5826 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  1.02754    0.01653   62.17   &lt;2e-16 ***
## xx           0.50214    0.01197   41.96   &lt;2e-16 ***
## w            0.73940    0.02398   30.83   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.9979 on 9997 degrees of freedom
## Multiple R-squared:  0.3711, Adjusted R-squared:  0.371 
## F-statistic:  2949 on 2 and 9997 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="IPW.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(yy<span class="sc">~</span>e<span class="sc">+</span>w,<span class="at">data=</span>dd) <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = yy ~ e + w, data = dd)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.6826 -0.6829  0.0072  0.6841  3.6734 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  0.06993    0.02219   3.152  0.00162 ** 
## e            1.73951    0.04332  40.153  &lt; 2e-16 ***
## w            0.74303    0.02437  30.496  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.004 on 9997 degrees of freedom
## Multiple R-squared:  0.363,  Adjusted R-squared:  0.3629 
## F-statistic:  2849 on 2 and 9997 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="IPW.html#cb76-1" aria-hidden="true" tabindex="-1"></a>dd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">temp=</span>w<span class="sc">*</span>yy<span class="sc">/</span>e<span class="sc">-</span>(<span class="dv">1</span><span class="sc">-</span>w)<span class="sc">*</span>yy<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>e)) <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="fu">mean</span>(temp))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   `mean(temp)`
##          &lt;dbl&gt;
## 1        0.741</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="IPW.html#cb78-1" aria-hidden="true" tabindex="-1"></a>dd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">temp=</span>w<span class="sc">*</span>yy<span class="sc">/</span>e) <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="fu">mean</span>(temp))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   `mean(temp)`
##          &lt;dbl&gt;
## 1         1.75</code></pre>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="IPW.html#cb80-1" aria-hidden="true" tabindex="-1"></a>dd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">temp=</span>(<span class="dv">1</span><span class="sc">-</span>w)<span class="sc">*</span>yy<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>e)) <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="fu">mean</span>(temp))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   `mean(temp)`
##          &lt;dbl&gt;
## 1         1.01</code></pre>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="IPW.html#cb82-1" aria-hidden="true" tabindex="-1"></a>dd <span class="sc">%&gt;%</span> <span class="fu">filter</span>(w<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">temp=</span>yy<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>e)) <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="fu">mean</span>(temp))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   `mean(temp)`
##          &lt;dbl&gt;
## 1         2.26</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="IPW.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 以下が1万にならないから、以下で割る必要がある。</span></span>
<span id="cb84-2"><a href="IPW.html#cb84-2" aria-hidden="true" tabindex="-1"></a>dd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">temp=</span>w<span class="sc">/</span>e) <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="fu">sum</span>(temp))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   `sum(temp)`
##         &lt;dbl&gt;
## 1       9843.</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="IPW.html#cb86-1" aria-hidden="true" tabindex="-1"></a>dd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">temp=</span>(<span class="dv">1</span><span class="sc">-</span>w)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>e)) <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="fu">sum</span>(temp))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   `sum(temp)`
##         &lt;dbl&gt;
## 1       9896.</code></pre>
</div>
<div id="操作変数的な変数を調整したときに起こるzバイアス" class="section level2" number="7.2">
<h2><span class="header-section-number">7.2</span> 操作変数的な変数を調整したときに起こるZバイアス</h2>
<p>ああ</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="IPW.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;ggdag&quot;)</span></span>
<span id="cb88-2"><a href="IPW.html#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdag)</span>
<span id="cb88-3"><a href="IPW.html#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb88-4"><a href="IPW.html#cb88-4" aria-hidden="true" tabindex="-1"></a>tidy_dag_2 <span class="ot">&lt;-</span> ggdag<span class="sc">::</span><span class="fu">dagify</span>(</span>
<span id="cb88-5"><a href="IPW.html#cb88-5" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> D <span class="sc">+</span> U,</span>
<span id="cb88-6"><a href="IPW.html#cb88-6" aria-hidden="true" tabindex="-1"></a>  D <span class="sc">~</span> Z <span class="sc">+</span> U,</span>
<span id="cb88-7"><a href="IPW.html#cb88-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">&quot;D&quot;</span>, <span class="co"># 処置変数（暴露 [exposure]） を指定 </span></span>
<span id="cb88-8"><a href="IPW.html#cb88-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">&quot;Y&quot;</span> ,  <span class="co"># 結果変数を指定</span></span>
<span id="cb88-9"><a href="IPW.html#cb88-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">latent =</span> <span class="st">&quot;U&quot;</span>,    <span class="co"># 未観測（潜在[latent]）変数を指定</span></span>
<span id="cb88-10"><a href="IPW.html#cb88-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">Z =</span> <span class="dv">0</span>, <span class="at">D =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">3</span>, <span class="at">U =</span> <span class="dv">2</span>),</span>
<span id="cb88-11"><a href="IPW.html#cb88-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Z =</span> <span class="dv">0</span>, <span class="at">D =</span> <span class="dv">0</span>, <span class="at">Y =</span> <span class="dv">0</span>, <span class="at">U =</span> <span class="dv">1</span>))</span>
<span id="cb88-12"><a href="IPW.html#cb88-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-13"><a href="IPW.html#cb88-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb88-14"><a href="IPW.html#cb88-14" aria-hidden="true" tabindex="-1"></a>  ggdag<span class="sc">::</span><span class="fu">tidy_dagitty</span>() </span>
<span id="cb88-15"><a href="IPW.html#cb88-15" aria-hidden="true" tabindex="-1"></a>ggdag<span class="sc">::</span><span class="fu">ggdag</span>(tidy_dag_2) <span class="sc">+</span> <span class="fu">theme_dag</span>()</span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<p>DGPは以下とする。</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="IPW.html#cb89-1" aria-hidden="true" tabindex="-1"></a>u<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb89-2"><a href="IPW.html#cb89-2" aria-hidden="true" tabindex="-1"></a>z<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb89-3"><a href="IPW.html#cb89-3" aria-hidden="true" tabindex="-1"></a>d<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>z<span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>u<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb89-4"><a href="IPW.html#cb89-4" aria-hidden="true" tabindex="-1"></a>y<span class="ot">&lt;-</span><span class="fl">0.5</span><span class="sc">*</span>d<span class="fl">+0.8</span><span class="sc">*</span>u<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb89-5"><a href="IPW.html#cb89-5" aria-hidden="true" tabindex="-1"></a>dt<span class="ot">&lt;-</span><span class="fu">tibble</span>(u,z,d,y)</span></code></pre></div>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="IPW.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>d,<span class="at">data=</span>dt) <span class="sc">%&gt;%</span>summary</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ d, data = dt)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.6210 -0.7475 -0.0264  0.7844  3.4969 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.200215   0.035869  -5.582 3.07e-08 ***
## d            0.669071   0.008948  74.770  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.089 on 998 degrees of freedom
## Multiple R-squared:  0.8485, Adjusted R-squared:  0.8484 
## F-statistic:  5591 on 1 and 998 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="IPW.html#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>d<span class="sc">+</span>z,<span class="at">data=</span>dt) <span class="sc">%&gt;%</span>summary</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ d + z, data = dt)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.5702 -0.7499 -0.0203  0.8076  2.9451 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.25192    0.03420  -7.367 3.66e-13 ***
## d            0.72688    0.00994  73.125  &lt; 2e-16 ***
## z           -0.42353    0.03835 -11.045  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.028 on 997 degrees of freedom
## Multiple R-squared:  0.865,  Adjusted R-squared:  0.8648 
## F-statistic:  3195 on 2 and 997 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="IPW.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;estimatr&quot;)</span></span>
<span id="cb94-2"><a href="IPW.html#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb94-3"><a href="IPW.html#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="fu">iv_robust</span>(y <span class="sc">~</span> d <span class="sc">|</span> z, <span class="at">data =</span> dt, </span>
<span id="cb94-4"><a href="IPW.html#cb94-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">se_type =</span> <span class="st">&quot;classical&quot;</span>) <span class="sc">%&gt;%</span>summary</span></code></pre></div>
<pre><code>## 
## Call:
## iv_robust(formula = y ~ d | z, data = dt, se_type = &quot;classical&quot;)
## 
## Standard error type:  classical 
## 
## Coefficients:
##             Estimate Std. Error t value   Pr(&gt;|t|) CI Lower CI Upper  DF
## (Intercept) -0.03114    0.04461 -0.6982  4.852e-01  -0.1187  0.05639 998
## d            0.51835    0.01926 26.9132 2.162e-120   0.4806  0.55615 998
## 
## Multiple R-squared:  0.8055 ,    Adjusted R-squared:  0.8053 
## F-statistic: 724.3 on 1 and 998 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="IPW.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ZXZY</span></span>
<span id="cb96-2"><a href="IPW.html#cb96-2" aria-hidden="true" tabindex="-1"></a>(z<span class="sc">%*%</span>y)<span class="sc">/</span>(z<span class="sc">%*%</span>d)</span></code></pre></div>
<pre><code>##           [,1]
## [1,] 0.5178849</code></pre>
</div>
<div id="直接効果と関節効果がある場合" class="section level2" number="7.3">
<h2><span class="header-section-number">7.3</span> 直接効果と関節効果がある場合</h2>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="IPW.html#cb98-1" aria-hidden="true" tabindex="-1"></a>tidy_dag_2 <span class="ot">&lt;-</span> ggdag<span class="sc">::</span><span class="fu">dagify</span>(</span>
<span id="cb98-2"><a href="IPW.html#cb98-2" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> D <span class="sc">+</span> A <span class="sc">+</span> U,</span>
<span id="cb98-3"><a href="IPW.html#cb98-3" aria-hidden="true" tabindex="-1"></a>  A <span class="sc">~</span> D <span class="sc">+</span> B,</span>
<span id="cb98-4"><a href="IPW.html#cb98-4" aria-hidden="true" tabindex="-1"></a>  D <span class="sc">~</span> U,</span>
<span id="cb98-5"><a href="IPW.html#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">&quot;D&quot;</span>, <span class="co"># 処置変数（暴露 [exposure]） を指定 </span></span>
<span id="cb98-6"><a href="IPW.html#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">&quot;Y&quot;</span> ,  <span class="co"># 結果変数を指定</span></span>
<span id="cb98-7"><a href="IPW.html#cb98-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">B =</span> <span class="dv">0</span>, <span class="at">A =</span> <span class="dv">2</span>, <span class="at">Y =</span> <span class="dv">3</span>, <span class="at">D =</span> <span class="dv">1</span>, <span class="at">U=</span><span class="dv">2</span>),</span>
<span id="cb98-8"><a href="IPW.html#cb98-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">B =</span> <span class="dv">1</span>, <span class="at">A =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="fl">0.5</span>, <span class="at">D =</span> <span class="fl">0.5</span>,<span class="at">U=</span><span class="dv">0</span>))</span>
<span id="cb98-9"><a href="IPW.html#cb98-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-10"><a href="IPW.html#cb98-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb98-11"><a href="IPW.html#cb98-11" aria-hidden="true" tabindex="-1"></a>  ggdag<span class="sc">::</span><span class="fu">tidy_dagitty</span>() </span>
<span id="cb98-12"><a href="IPW.html#cb98-12" aria-hidden="true" tabindex="-1"></a>ggdag<span class="sc">::</span><span class="fu">ggdag</span>(tidy_dag_2) <span class="sc">+</span> <span class="fu">theme_dag</span>()</span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-45-1.png" width="672" /></p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="IPW.html#cb99-1" aria-hidden="true" tabindex="-1"></a>u<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb99-2"><a href="IPW.html#cb99-2" aria-hidden="true" tabindex="-1"></a>b<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb99-3"><a href="IPW.html#cb99-3" aria-hidden="true" tabindex="-1"></a>d<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>u<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb99-4"><a href="IPW.html#cb99-4" aria-hidden="true" tabindex="-1"></a>a<span class="ot">&lt;-</span><span class="dv">2</span><span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>d<span class="fl">+0.5</span><span class="sc">*</span>b<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb99-5"><a href="IPW.html#cb99-5" aria-hidden="true" tabindex="-1"></a>y<span class="ot">&lt;-</span><span class="fl">0.5</span><span class="sc">*</span>d<span class="sc">+</span>a<span class="fl">+0.8</span><span class="sc">*</span>u<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb99-6"><a href="IPW.html#cb99-6" aria-hidden="true" tabindex="-1"></a>dt<span class="ot">&lt;-</span><span class="fu">tibble</span>(u,d,y,a,b)</span></code></pre></div>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="IPW.html#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>d<span class="sc">+</span>u,<span class="at">data=</span>dt) <span class="sc">%&gt;%</span>summary <span class="co">#正しい総合効果は2.5</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ d + u, data = dt)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -4.6576 -1.0581 -0.0450  0.9733  4.3614 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  2.04545    0.06703  30.516  &lt; 2e-16 ***
## d            2.44245    0.04730  51.634  &lt; 2e-16 ***
## u            0.99958    0.15017   6.656 4.63e-11 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.509 on 997 degrees of freedom
## Multiple R-squared:  0.9712, Adjusted R-squared:  0.9712 
## F-statistic: 1.682e+04 on 2 and 997 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="IPW.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>d<span class="sc">+</span>a<span class="sc">+</span>u,<span class="at">data=</span>dt) <span class="sc">%&gt;%</span>summary <span class="co">#正しい直接効果は0.5</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ d + a + u, data = dt)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -2.9130 -0.6525 -0.0081  0.6862  3.2309 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 0.003435   0.070924   0.048    0.961    
## d           0.445604   0.062701   7.107 2.26e-12 ***
## a           1.009484   0.027580  36.602  &lt; 2e-16 ***
## u           0.895338   0.098152   9.122  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.9859 on 996 degrees of freedom
## Multiple R-squared:  0.9877, Adjusted R-squared:  0.9877 
## F-statistic: 2.671e+04 on 3 and 996 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="IPW.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>d<span class="sc">+</span>a,<span class="at">data=</span>dt) <span class="sc">%&gt;%</span>summary</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ d + a, data = dt)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.1291 -0.6385 -0.0021  0.7201  3.2600 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.27832    0.06642   -4.19 3.04e-05 ***
## d            0.69850    0.05851   11.94  &lt; 2e-16 ***
## a            1.01678    0.02868   35.45  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.026 on 997 degrees of freedom
## Multiple R-squared:  0.9867, Adjusted R-squared:  0.9867 
## F-statistic: 3.697e+04 on 2 and 997 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="IPW.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;estimatr&quot;)</span></span>
<span id="cb106-2"><a href="IPW.html#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb106-3"><a href="IPW.html#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="fu">iv_robust</span>(y <span class="sc">~</span> d<span class="sc">+</span>a <span class="sc">|</span> a<span class="sc">+</span>b, <span class="at">data =</span> dt, </span>
<span id="cb106-4"><a href="IPW.html#cb106-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">se_type =</span> <span class="st">&quot;classical&quot;</span>) <span class="sc">%&gt;%</span>summary</span></code></pre></div>
<pre><code>## 
## Call:
## iv_robust(formula = y ~ d + a | a + b, data = dt, se_type = &quot;classical&quot;)
## 
## Standard error type:  classical 
## 
## Coefficients:
##             Estimate Std. Error t value  Pr(&gt;|t|) CI Lower CI Upper  DF
## (Intercept) -0.01584    0.12474  -0.127 8.990e-01  -0.2606    0.229 997
## d            0.97995    0.12729   7.698 3.311e-14   0.7302    1.230 997
## a            0.88091    0.06166  14.287 2.883e-42   0.7599    1.002 997
## 
## Multiple R-squared:  0.9864 ,    Adjusted R-squared:  0.9864 
## F-statistic: 3.61e+04 on 2 and 997 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div id="処置の結果変数は操作変数になりうるか" class="section level2" number="7.4">
<h2><span class="header-section-number">7.4</span> 処置の結果変数は操作変数になりうるか？</h2>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="IPW.html#cb108-1" aria-hidden="true" tabindex="-1"></a>tidy_dag_2 <span class="ot">&lt;-</span> ggdag<span class="sc">::</span><span class="fu">dagify</span>(</span>
<span id="cb108-2"><a href="IPW.html#cb108-2" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> D <span class="sc">+</span> U,</span>
<span id="cb108-3"><a href="IPW.html#cb108-3" aria-hidden="true" tabindex="-1"></a>  D <span class="sc">~</span>  U,</span>
<span id="cb108-4"><a href="IPW.html#cb108-4" aria-hidden="true" tabindex="-1"></a>  Z <span class="sc">~</span> D,</span>
<span id="cb108-5"><a href="IPW.html#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">&quot;D&quot;</span>, <span class="co"># 処置変数（暴露 [exposure]） を指定 </span></span>
<span id="cb108-6"><a href="IPW.html#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">&quot;Y&quot;</span> ,  <span class="co"># 結果変数を指定</span></span>
<span id="cb108-7"><a href="IPW.html#cb108-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">latent =</span> <span class="st">&quot;U&quot;</span>,    <span class="co"># 未観測（潜在[latent]）変数を指定</span></span>
<span id="cb108-8"><a href="IPW.html#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">Z =</span> <span class="dv">0</span>, <span class="at">D =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">3</span>, <span class="at">U =</span> <span class="dv">2</span>),</span>
<span id="cb108-9"><a href="IPW.html#cb108-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Z =</span> <span class="dv">0</span>, <span class="at">D =</span> <span class="dv">0</span>, <span class="at">Y =</span> <span class="dv">0</span>, <span class="at">U =</span> <span class="dv">1</span>))</span>
<span id="cb108-10"><a href="IPW.html#cb108-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-11"><a href="IPW.html#cb108-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb108-12"><a href="IPW.html#cb108-12" aria-hidden="true" tabindex="-1"></a>  ggdag<span class="sc">::</span><span class="fu">tidy_dagitty</span>() </span>
<span id="cb108-13"><a href="IPW.html#cb108-13" aria-hidden="true" tabindex="-1"></a>ggdag<span class="sc">::</span><span class="fu">ggdag</span>(tidy_dag_2) <span class="sc">+</span> <span class="fu">theme_dag</span>()</span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-48-1.png" width="672" /></p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="IPW.html#cb109-1" aria-hidden="true" tabindex="-1"></a>u<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb109-2"><a href="IPW.html#cb109-2" aria-hidden="true" tabindex="-1"></a>d<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>u<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb109-3"><a href="IPW.html#cb109-3" aria-hidden="true" tabindex="-1"></a>z<span class="ot">&lt;-</span><span class="dv">2</span><span class="sc">*</span>d<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb109-4"><a href="IPW.html#cb109-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-5"><a href="IPW.html#cb109-5" aria-hidden="true" tabindex="-1"></a>y<span class="ot">&lt;-</span><span class="fl">0.5</span><span class="sc">*</span>d<span class="fl">+0.8</span><span class="sc">*</span>u<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb109-6"><a href="IPW.html#cb109-6" aria-hidden="true" tabindex="-1"></a>dt<span class="ot">&lt;-</span><span class="fu">tibble</span>(u,z,d,y)</span></code></pre></div>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="IPW.html#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>d,<span class="at">data=</span>dt) <span class="sc">%&gt;%</span>summary <span class="co">#biased</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ d, data = dt)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.6746 -0.6928 -0.0157  0.6955  3.0680 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.25310    0.03456  -7.323 4.99e-13 ***
## d            0.73716    0.01044  70.634  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.042 on 998 degrees of freedom
## Multiple R-squared:  0.8333, Adjusted R-squared:  0.8331 
## F-statistic:  4989 on 1 and 998 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="IPW.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>d<span class="sc">+</span>z,<span class="at">data=</span>dt) <span class="sc">%&gt;%</span>summary <span class="co">#biased</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ d + z, data = dt)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.6799 -0.6909 -0.0167  0.7007  3.0706 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.252989   0.034582  -7.316 5.26e-13 ***
## d            0.753898   0.066978  11.256  &lt; 2e-16 ***
## z           -0.008351   0.033008  -0.253      0.8    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.043 on 997 degrees of freedom
## Multiple R-squared:  0.8333, Adjusted R-squared:  0.833 
## F-statistic:  2492 on 2 and 997 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="IPW.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;estimatr&quot;)</span></span>
<span id="cb114-2"><a href="IPW.html#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb114-3"><a href="IPW.html#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="fu">iv_robust</span>(y <span class="sc">~</span> d <span class="sc">|</span> z, <span class="at">data =</span> dt, </span>
<span id="cb114-4"><a href="IPW.html#cb114-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">se_type =</span> <span class="st">&quot;classical&quot;</span>) <span class="sc">%&gt;%</span>summary</span></code></pre></div>
<pre><code>## 
## Call:
## iv_robust(formula = y ~ d | z, data = dt, se_type = &quot;classical&quot;)
## 
## Standard error type:  classical 
## 
## Coefficients:
##             Estimate Std. Error t value  Pr(&gt;|t|) CI Lower CI Upper  DF
## (Intercept)  -0.2527    0.03460  -7.303 5.764e-13  -0.3206  -0.1848 998
## d             0.7367    0.01057  69.731 0.000e+00   0.7160   0.7575 998
## 
## Multiple R-squared:  0.8333 ,    Adjusted R-squared:  0.8331 
## F-statistic:  4862 on 1 and 998 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>操作変数はUと独立でなければならない。そのため、上の例はダメ。下の例ならOK。下の例ではAもZも操作変数となる。（Aが観測できるならAでよいが、観測できなくてもZを使える）</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="IPW.html#cb116-1" aria-hidden="true" tabindex="-1"></a>tidy_dag_2 <span class="ot">&lt;-</span> ggdag<span class="sc">::</span><span class="fu">dagify</span>(</span>
<span id="cb116-2"><a href="IPW.html#cb116-2" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> D <span class="sc">+</span> U,</span>
<span id="cb116-3"><a href="IPW.html#cb116-3" aria-hidden="true" tabindex="-1"></a>  D <span class="sc">~</span>  U<span class="sc">+</span>A,</span>
<span id="cb116-4"><a href="IPW.html#cb116-4" aria-hidden="true" tabindex="-1"></a>  Z <span class="sc">~</span> A,</span>
<span id="cb116-5"><a href="IPW.html#cb116-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">&quot;D&quot;</span>, <span class="co"># 処置変数（暴露 [exposure]） を指定 </span></span>
<span id="cb116-6"><a href="IPW.html#cb116-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">&quot;Y&quot;</span> ,  <span class="co"># 結果変数を指定</span></span>
<span id="cb116-7"><a href="IPW.html#cb116-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">latent =</span> <span class="st">&quot;U&quot;</span>,    <span class="co"># 未観測（潜在[latent]）変数を指定</span></span>
<span id="cb116-8"><a href="IPW.html#cb116-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">Z =</span> <span class="dv">1</span>, <span class="at">D =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">3</span>, <span class="at">U =</span> <span class="dv">2</span>,<span class="at">A=</span><span class="dv">0</span>),</span>
<span id="cb116-9"><a href="IPW.html#cb116-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Z =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">D =</span> <span class="dv">0</span>, <span class="at">Y =</span> <span class="dv">0</span>, <span class="at">U =</span> <span class="dv">1</span>,<span class="at">A=</span><span class="dv">0</span>))</span>
<span id="cb116-10"><a href="IPW.html#cb116-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-11"><a href="IPW.html#cb116-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb116-12"><a href="IPW.html#cb116-12" aria-hidden="true" tabindex="-1"></a>  ggdag<span class="sc">::</span><span class="fu">tidy_dagitty</span>() </span>
<span id="cb116-13"><a href="IPW.html#cb116-13" aria-hidden="true" tabindex="-1"></a>ggdag<span class="sc">::</span><span class="fu">ggdag</span>(tidy_dag_2) <span class="sc">+</span> <span class="fu">theme_dag</span>()</span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-51-1.png" width="672" /></p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="IPW.html#cb117-1" aria-hidden="true" tabindex="-1"></a>u<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb117-2"><a href="IPW.html#cb117-2" aria-hidden="true" tabindex="-1"></a>a<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb117-3"><a href="IPW.html#cb117-3" aria-hidden="true" tabindex="-1"></a>d<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>a<span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>u<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb117-4"><a href="IPW.html#cb117-4" aria-hidden="true" tabindex="-1"></a>y<span class="ot">&lt;-</span><span class="fl">0.5</span><span class="sc">*</span>d<span class="fl">+0.8</span><span class="sc">*</span>u<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb117-5"><a href="IPW.html#cb117-5" aria-hidden="true" tabindex="-1"></a>z<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">+</span>a<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb117-6"><a href="IPW.html#cb117-6" aria-hidden="true" tabindex="-1"></a>dt<span class="ot">&lt;-</span><span class="fu">tibble</span>(u,z,d,y,a)</span></code></pre></div>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="IPW.html#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>d,<span class="at">data=</span>dt) <span class="sc">%&gt;%</span>summary <span class="co">#biased</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ d, data = dt)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.2848 -0.7733  0.0242  0.7822  3.1403 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.234727   0.035850  -6.547 9.35e-11 ***
## d            0.670178   0.009602  69.794  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.103 on 998 degrees of freedom
## Multiple R-squared:   0.83,  Adjusted R-squared:  0.8298 
## F-statistic:  4871 on 1 and 998 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="IPW.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>d<span class="sc">+</span>z,<span class="at">data=</span>dt) <span class="sc">%&gt;%</span>summary <span class="co">#biased</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ d + z, data = dt)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -3.08517 -0.76739  0.02363  0.77817  3.12588 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.10115    0.04175  -2.423   0.0156 *  
## d            0.69103    0.01007  68.654  &lt; 2e-16 ***
## z           -0.15857    0.02656  -5.970  3.3e-09 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.084 on 997 degrees of freedom
## Multiple R-squared:  0.8358, Adjusted R-squared:  0.8355 
## F-statistic:  2538 on 2 and 997 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="IPW.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)  </span>
<span id="cb122-2"><a href="IPW.html#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="co">#unbiased</span></span>
<span id="cb122-3"><a href="IPW.html#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="fu">iv_robust</span>(y <span class="sc">~</span> d <span class="sc">|</span> z, <span class="at">data =</span> dt, </span>
<span id="cb122-4"><a href="IPW.html#cb122-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">se_type =</span> <span class="st">&quot;classical&quot;</span>) <span class="sc">%&gt;%</span>summary</span></code></pre></div>
<pre><code>## 
## Call:
## iv_robust(formula = y ~ d | z, data = dt, se_type = &quot;classical&quot;)
## 
## Standard error type:  classical 
## 
## Coefficients:
##             Estimate Std. Error t value  Pr(&gt;|t|) CI Lower  CI Upper  DF
## (Intercept)  -0.1024    0.04738  -2.162 3.089e-02  -0.1954 -0.009442 998
## d             0.5179    0.03096  16.730 1.428e-55   0.4572  0.578651 998
## 
## Multiple R-squared:  0.7871 ,    Adjusted R-squared:  0.7869 
## F-statistic: 279.9 on 1 and 998 DF,  p-value: &lt; 2.2e-16</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="heterogeneous-treatment-effect-1.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/IPW.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
