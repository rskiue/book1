<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>chapter: 6 HTE I: Binary treatment | IPW</title>
  <meta name="description" content="This is a description. Please wrote a abstract this contents." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="chapter: 6 HTE I: Binary treatment | IPW" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a description. Please wrote a abstract this contents." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="chapter: 6 HTE I: Binary treatment | IPW" />
  
  <meta name="twitter:description" content="This is a description. Please wrote a abstract this contents." />
  

<meta name="author" content="author_name" />


<meta name="date" content="2023-04-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="04-literature.html"/>
<link rel="next" href="IPW.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">サイト(書籍)タイトルいれてね</a></li>

<li class="divider"></li>
<li><a href="index.html#book_title" id="toc-book_title"><span class="toc-section-number">1</span> book_title</a>
<ul>
<li><a href="index.html#書籍作成方法" id="toc-書籍作成方法"><span class="toc-section-number">1.1</span> 書籍作成方法</a></li>
<li><a href="index.html#必要なパッケージ環境など" id="toc-必要なパッケージ環境など"><span class="toc-section-number">1.2</span> 必要なパッケージ,環境など</a></li>
</ul></li>
<li><a href="01-title1.html#メモ" id="toc-メモ"><span class="toc-section-number">2</span> メモ</a></li>
<li><a href="02-title2.html#章のタイトル2" id="toc-章のタイトル2"><span class="toc-section-number">3</span> 章のタイトル2</a>
<ul>
<li><a href="02-title2.html#節見出し1" id="toc-節見出し1"><span class="toc-section-number">3.1</span> 節見出し1</a></li>
<li><a href="02-title2.html#節見出し2" id="toc-節見出し2"><span class="toc-section-number">3.2</span> 節見出し2</a></li>
</ul></li>
<li><a href="03-method.html#methods" id="toc-methods"><span class="toc-section-number">4</span> Methods</a>
<ul>
<li><a href="03-method.html#sls" id="toc-sls"><span class="toc-section-number">4.1</span> 2SLS</a>
<ul>
<li><a href="03-method.html#setting" id="toc-setting"><span class="toc-section-number">4.1.1</span> Setting</a></li>
<li><a href="03-method.html#dgp" id="toc-dgp"><span class="toc-section-number">4.1.2</span> DGP</a></li>
<li><a href="03-method.html#パッケージを用いた推定" id="toc-パッケージを用いた推定"><span class="toc-section-number">4.1.3</span> パッケージを用いた推定</a></li>
<li><a href="03-method.html#手計算で計算する場合" id="toc-手計算で計算する場合"><span class="toc-section-number">4.1.4</span> 手計算で計算する場合</a></li>
</ul></li>
<li><a href="03-method.html#gmm" id="toc-gmm"><span class="toc-section-number">4.2</span> GMM</a>
<ul>
<li><a href="03-method.html#適切なウェイトの選び方末石5.2.3" id="toc-適切なウェイトの選び方末石5.2.3"><span class="toc-section-number">4.2.1</span> 適切なウェイトの選び方（末石5.2.3）</a></li>
<li><a href="03-method.html#線形モデルでない場合" id="toc-線形モデルでない場合"><span class="toc-section-number">4.2.2</span> 線形モデルでない場合</a></li>
<li><a href="03-method.html#非線形モデルが内生性がない場合" id="toc-非線形モデルが内生性がない場合"><span class="toc-section-number">4.2.3</span> 非線形モデルが内生性がない場合</a></li>
<li><a href="03-method.html#内生性がある場合の非線形モデル" id="toc-内生性がある場合の非線形モデル"><span class="toc-section-number">4.2.4</span> 内生性がある場合の非線形モデル</a></li>
</ul></li>
</ul></li>
<li><a href="04-literature.html#メモ-1" id="toc-メモ-1"><span class="toc-section-number">5</span> メモ</a>
<ul>
<li><a href="04-literature.html#bookdown関連" id="toc-bookdown関連"><span class="toc-section-number">5.1</span> Bookdown関連</a></li>
<li><a href="04-literature.html#docker関連" id="toc-docker関連"><span class="toc-section-number">5.2</span> Docker関連</a>
<ul>
<li><a href="04-literature.html#参考情報" id="toc-参考情報"><span class="toc-section-number">5.2.1</span> 参考情報</a></li>
</ul></li>
</ul></li>
<li><a href="heterogeneous-treatment-effect-1.html#hte-i-binary-treatment" id="toc-hte-i-binary-treatment"><span class="toc-section-number">6</span> HTE I: Binary treatment</a>
<ul>
<li><a href="heterogeneous-treatment-effect-1.html#pre-specified-hypotheses" id="toc-pre-specified-hypotheses"><span class="toc-section-number">6.1</span> Pre-specified hypotheses</a></li>
<li><a href="heterogeneous-treatment-effect-1.html#data-driven-hypotheses" id="toc-data-driven-hypotheses"><span class="toc-section-number">6.2</span> Data-driven hypotheses</a>
<ul>
<li><a href="heterogeneous-treatment-effect-1.html#via-causal-trees" id="toc-via-causal-trees"><span class="toc-section-number">6.2.1</span> Via causal trees</a></li>
<li><a href="heterogeneous-treatment-effect-1.html#via-grf" id="toc-via-grf"><span class="toc-section-number">6.2.2</span> Via grf</a></li>
<li><a href="heterogeneous-treatment-effect-1.html#実際の活用におけるプロセス" id="toc-実際の活用におけるプロセス"><span class="toc-section-number">6.2.3</span> 実際の活用におけるプロセス</a></li>
</ul></li>
<li><a href="heterogeneous-treatment-effect-1.html#further-reading" id="toc-further-reading"><span class="toc-section-number">6.3</span> Further reading</a></li>
</ul></li>
<li><a href="IPW.html#ipwや操作変数について" id="toc-ipwや操作変数について"><span class="toc-section-number">7</span> IPWや操作変数について</a>
<ul>
<li><a href="IPW.html#ipw" id="toc-ipw"><span class="toc-section-number">7.1</span> IPW</a></li>
<li><a href="IPW.html#操作変数的な変数を調整したときに起こるzバイアス" id="toc-操作変数的な変数を調整したときに起こるzバイアス"><span class="toc-section-number">7.2</span> 操作変数的な変数を調整したときに起こるZバイアス</a></li>
<li><a href="IPW.html#直接効果と関節効果がある場合" id="toc-直接効果と関節効果がある場合"><span class="toc-section-number">7.3</span> 直接効果と関節効果がある場合</a></li>
<li><a href="IPW.html#処置の結果変数は操作変数になりうるか" id="toc-処置の結果変数は操作変数になりうるか"><span class="toc-section-number">7.4</span> 処置の結果変数は操作変数になりうるか？</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">IPW</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hte-i-binary-treatment" class="section level1" number="6">
<h1><span class="header-section-number">chapter: 6</span> HTE I: Binary treatment</h1>
<p>Source RMD file:
<a href="https://docs.google.com/uc?export=download&amp;id=1FSUi4WLfYYKnvWsNWypiQORhkqf5IlFP">link</a></p>
<p>前章では、母集団全員に対する平均処置効果について学んできた。しかし、平均効果を見るだけでは、ある個々人がどのように処置に対して反応したかという重要な事実を十分に把握することができない。そこでこの章では、以下で定義される条件付き因果効果（CATE）について見ていく。</p>
<blockquote>
<p>In the previous chapter, we learned how to estimate the effect of a
binary treatment averaged over the entire population. However, the
average may obscure important details about how different individuals
react to the treatment. In this chapter, we will learn how to estimate
the <strong>conditional average treatment effect (CATE)</strong>,</p>
</blockquote>
<span class="math display" id="eq:cate">\[\begin{equation}
  \tag{6.1}  \tau(x) := \mathop{\mathrm{E}}[Y_i(1) - Y_i(0) | X_i = x]
\end{equation}\]</span>
<p>これは、「localized」されたバージョンの平均処置効果であり、観察可能な変数で条件付けされたものである。</p>
<p><a href="heterogeneous-treatment-effect-1.html#eq:cate">(6.1)</a>
は一般化しすぎていて利用しにくいことがしばしばあり、特に共変量が高次元な場合には顕著である。強いモデリングの仮定をおかない限りは、信頼のおける推定は難しく、推定後に結果を意味のある形で要約することも難しい。そこで代わりに、単純なグループごとの処置効果の平均値を推定することとする。</p>
<p>which is a “localized” version of the average treatment effect
conditional on a vector of observable characteristics.</p>
<p>It’s often the case that <a href="heterogeneous-treatment-effect-1.html#eq:cate">(6.1)</a> is too general to be immediately
useful, especially when the observable covariates are high-dimensional.
It can be hard to estimate reliably without making strong modeling
assumptions, and hard to summarize in a useful manner after estimation.
In such situations, we will instead try to estimate treatment effect
averages for simpler groups</p>
<span class="math display" id="eq:cate-g">\[\begin{equation}
  \tag{6.2}
  \mathop{\mathrm{E}}[Y_i(1) - Y_i(0) | G_i = g],
\end{equation}\]</span>
<p>以下では、あらかじめ定義したサブグループ別の処置効果について推定するのと、サブグループを見つける方法（Data
drivenで）を見ていく。</p>
<p>where <span class="math inline">\(G_i\)</span> indexes subgroups of interest. Below you’ll learn how to
estimate and test hypotheses about pre-defined subgroups, and also how
to discover subgroups of interest from the data. In this tutorial, you
will learn how to use estimates of <a href="heterogeneous-treatment-effect-1.html#eq:cate">(6.1)</a> to suggest relevant
subgroups <span class="math inline">\(G_i\)</span> (and in the next chapters you will find out other uses
of <a href="heterogeneous-treatment-effect-1.html#eq:cate">(6.1)</a> in policy learning and evaluation).</p>
<p>GSSのデータを使用する。RCTデータだが、以下で見ていく手法は、Unconfoundednessが成り立っている限りは観察データにも利用できる。</p>
<p>We’ll continue using the abridged version of the General Social Survey
(GSS) <a href="https://gss.norc.org/Documents/reports/project-reports/GSSProject%20report32.pdf">(Smith,
2016)</a>
dataset that was introduced in the previous chapter. In this dataset,
individuals were sent to treatment or control with equal probability, so
we are in a randomized setting. However, many of the techniques and code
shown below should also work in an observational setting provided that
unconfoundedness and overlap are satisfied (these assumptions were
defined in the previous chapter).</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="heterogeneous-treatment-effect-1.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pacmanでのインストールに変更した</span></span>
<span id="cb41-2"><a href="heterogeneous-treatment-effect-1.html#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># causalTreeはCRANにないのでGithubよりダウンロード</span></span>
<span id="cb41-3"><a href="heterogeneous-treatment-effect-1.html#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="heterogeneous-treatment-effect-1.html#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;pacman&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;pacman&quot;</span>)</span>
<span id="cb41-5"><a href="heterogeneous-treatment-effect-1.html#cb41-5" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse,</span>
<span id="cb41-6"><a href="heterogeneous-treatment-effect-1.html#cb41-6" aria-hidden="true" tabindex="-1"></a>               grf,</span>
<span id="cb41-7"><a href="heterogeneous-treatment-effect-1.html#cb41-7" aria-hidden="true" tabindex="-1"></a>               rpart,</span>
<span id="cb41-8"><a href="heterogeneous-treatment-effect-1.html#cb41-8" aria-hidden="true" tabindex="-1"></a>               glmnet,</span>
<span id="cb41-9"><a href="heterogeneous-treatment-effect-1.html#cb41-9" aria-hidden="true" tabindex="-1"></a>               splines,</span>
<span id="cb41-10"><a href="heterogeneous-treatment-effect-1.html#cb41-10" aria-hidden="true" tabindex="-1"></a>               MASS,</span>
<span id="cb41-11"><a href="heterogeneous-treatment-effect-1.html#cb41-11" aria-hidden="true" tabindex="-1"></a>               lmtest,</span>
<span id="cb41-12"><a href="heterogeneous-treatment-effect-1.html#cb41-12" aria-hidden="true" tabindex="-1"></a>               sandwich,</span>
<span id="cb41-13"><a href="heterogeneous-treatment-effect-1.html#cb41-13" aria-hidden="true" tabindex="-1"></a>               devtools,</span>
<span id="cb41-14"><a href="heterogeneous-treatment-effect-1.html#cb41-14" aria-hidden="true" tabindex="-1"></a>               reshape2)</span>
<span id="cb41-15"><a href="heterogeneous-treatment-effect-1.html#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;causalTree&quot;</span>)) devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&#39;susanathey/causalTree&#39;</span>) </span></code></pre></div>
<p>As with other chapters in this tutorial, the code below should still
work by replacing the next snippet of code with a different dataset,
provided that you update the key variables <code>treatment</code>, <code>outcome</code>, and
<code>covariates</code> below. Also, please make sure to read the comments as they
may be subtle differences depending on whether your dataset was created
in a randomized or observational setting.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="heterogeneous-treatment-effect-1.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in data</span></span>
<span id="cb42-2"><a href="heterogeneous-treatment-effect-1.html#cb42-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://docs.google.com/uc?id=1kSxrVci_EUcSr_Lg1JKk1l7Xd5I9zfRC&amp;export=download&quot;</span>)</span>
<span id="cb42-3"><a href="heterogeneous-treatment-effect-1.html#cb42-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb42-4"><a href="heterogeneous-treatment-effect-1.html#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="heterogeneous-treatment-effect-1.html#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment: does the the gov&#39;t spend too much on &quot;welfare&quot; (1) or &quot;assistance to the poor&quot; (0)</span></span>
<span id="cb42-6"><a href="heterogeneous-treatment-effect-1.html#cb42-6" aria-hidden="true" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="st">&quot;w&quot;</span></span>
<span id="cb42-7"><a href="heterogeneous-treatment-effect-1.html#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="heterogeneous-treatment-effect-1.html#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome: 1 for &#39;yes&#39;, 0 for &#39;no&#39;</span></span>
<span id="cb42-9"><a href="heterogeneous-treatment-effect-1.html#cb42-9" aria-hidden="true" tabindex="-1"></a>outcome <span class="ot">&lt;-</span> <span class="st">&quot;y&quot;</span></span>
<span id="cb42-10"><a href="heterogeneous-treatment-effect-1.html#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="heterogeneous-treatment-effect-1.html#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional covariates</span></span>
<span id="cb42-12"><a href="heterogeneous-treatment-effect-1.html#cb42-12" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;polviews&quot;</span>, <span class="st">&quot;income&quot;</span>, <span class="st">&quot;educ&quot;</span>, <span class="st">&quot;marital&quot;</span>, <span class="st">&quot;sex&quot;</span>)</span></code></pre></div>
<p>データの形状</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="heterogeneous-treatment-effect-1.html#cb43-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##        X               y                w               age      
##  Min.   :    1   Min.   :0.0000   Min.   :0.0000   Min.   :18.0  
##  1st Qu.: 8276   1st Qu.:0.0000   1st Qu.:0.0000   1st Qu.:32.0  
##  Median :16649   Median :0.0000   Median :1.0000   Median :43.0  
##  Mean   :17552   Mean   :0.2543   Mean   :0.5345   Mean   :45.3  
##  3rd Qu.:28017   3rd Qu.:1.0000   3rd Qu.:1.0000   3rd Qu.:57.0  
##  Max.   :36501   Max.   :1.0000   Max.   :1.0000   Max.   :89.0  
##     polviews         income          educ          marital         sex       
##  Min.   :1.000   Min.   : 1.0   Min.   : 0.00   Min.   :1.0   Min.   :1.000  
##  1st Qu.:3.000   1st Qu.:10.0   1st Qu.:12.00   1st Qu.:1.0   1st Qu.:1.000  
##  Median :4.000   Median :12.0   Median :13.00   Median :1.0   Median :2.000  
##  Mean   :4.107   Mean   :10.6   Mean   :13.29   Mean   :2.4   Mean   :1.548  
##  3rd Qu.:5.000   3rd Qu.:12.0   3rd Qu.:16.00   3rd Qu.:4.0   3rd Qu.:2.000  
##  Max.   :7.000   Max.   :12.0   Max.   :20.00   Max.   :5.0   Max.   :2.000</code></pre>
<div id="pre-specified-hypotheses" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Pre-specified hypotheses</h2>
<p>ここではデータを見る前にグループは決まっていた(pre-specified)と考える。単に処置とグループの交差項を入れておけば良い。</p>
<p>We will begin by learning how to test pre-specified null hypotheses of
the form</p>
<p><span class="math display">\[
H_{0}: \mathop{\mathrm{E}}[Y(1) - Y(0) | G_i = 1] = \mathop{\mathrm{E}}[Y(1) - Y(0) | G_i = 0].
\]</span></p>
<p>That is, that the treatment effect is the same regardless of membership
to some group <span class="math inline">\(G_i\)</span>. Importantly, for now we’ll assume that the group
<span class="math inline">\(G_i\)</span> was <strong>pre-specified</strong> – it was decided <em>before</em> looking at the
data.</p>
<p>In a randomized setting, if the both the treatment <span class="math inline">\(W_i\)</span> and group
membership <span class="math inline">\(G_i\)</span> are binary, we can write</p>
<p><span class="math display">\[
\mathop{\mathrm{E}}[Y_i(W_i)|G_i] = \mathop{\mathrm{E}}[Y_i|W_i, G_i] = \beta_0 + \beta_w W_i + \beta_g G_i + \beta_{wg} W_i G_i
\]</span></p>
<p>When <span class="math inline">\(W_i\)</span> and <span class="math inline">\(G_i\)</span> are binary, this decomposition is true without loss
of generality. Why?</p>
<p>This allows us to write the average effects of <span class="math inline">\(W_i\)</span> and <span class="math inline">\(G_i\)</span> on <span class="math inline">\(Y_i\)</span>
as</p>
<p><span class="math display">\[
\mathop{\mathrm{E}}[Y(1) | G_i=1] = \beta_0 + \beta_w W_i + \beta_g G_i + \beta_{wg} W_i G_i,\\
\mathop{\mathrm{E}}[Y(1) | G_i=0] = \beta_0 + \beta_w W_i,  \\
\mathop{\mathrm{E}}[Y(0) | G_i=1] = \beta_0 + \beta_g G_i,  \\
\mathop{\mathrm{E}}[Y(0) | G_i=0] = \beta_0.
\]</span></p>
<p>政治的志向が4未満をconservative、4以上をliveralとするバイナリ変数を新たに作る。</p>
<p>処置Wとの交差項を見ることで政治志向による処置効果の違いを見ることができる。</p>
<blockquote>
<p>Rewriting the null hypothesis <a href="#eq:hte-hyp">(<strong>??</strong>)</a> in terms of the
decomposition <a href="#eq:decomp">(<strong>??</strong>)</a>, we see that it boils down to a test
about the coefficient in the interaction: <span class="math inline">\(\beta_{xw} = 0\)</span>. Here’s an
example that tests whether the treatment effect is the same for
“conservative” (<code>polviews</code> &lt; 4) and “liberal” (<code>polviews</code> <span class="math inline">\(\geq\)</span> 4)
individuals.</p>
</blockquote>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="heterogeneous-treatment-effect-1.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Only valid in randomized settings</span></span>
<span id="cb45-2"><a href="heterogeneous-treatment-effect-1.html#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="heterogeneous-treatment-effect-1.html#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppose this his group was defined prior to collecting the data</span></span>
<span id="cb45-4"><a href="heterogeneous-treatment-effect-1.html#cb45-4" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>conservative <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>polviews <span class="sc">&lt;</span> <span class="dv">4</span>)  <span class="co"># a binary group</span></span>
<span id="cb45-5"><a href="heterogeneous-treatment-effect-1.html#cb45-5" aria-hidden="true" tabindex="-1"></a>group <span class="ot">&lt;-</span> <span class="st">&#39;conservative&#39;</span></span>
<span id="cb45-6"><a href="heterogeneous-treatment-effect-1.html#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="heterogeneous-treatment-effect-1.html#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Recall from last chapter -- this is equivalent to running a t-test</span></span>
<span id="cb45-8"><a href="heterogeneous-treatment-effect-1.html#cb45-8" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste</span>(outcome, <span class="st">&#39; ~ &#39;</span>, treatment, <span class="st">&#39;*&#39;</span>, group))</span>
<span id="cb45-9"><a href="heterogeneous-treatment-effect-1.html#cb45-9" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span>data)</span>
<span id="cb45-10"><a href="heterogeneous-treatment-effect-1.html#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="at">type=</span><span class="st">&#39;HC2&#39;</span>))</span></code></pre></div>
<pre><code>## 
## t test of coefficients:
## 
##                      Estimate Std. Error t value  Pr(&gt;|t|)    
## (Intercept)         0.4836473  0.0050842  95.127 &lt; 2.2e-16 ***
## w                  -0.3789182  0.0058604 -64.657 &lt; 2.2e-16 ***
## conservativeTRUE   -0.1590214  0.0092479 -17.195 &lt; 2.2e-16 ***
## w:conservativeTRUE  0.1160034  0.0103710  11.185 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p><font size=1> Interpret the results above. The coefficient <span class="math inline">\(\beta_{xw}\)</span>
is denoted by <code>w:conservativeTRUE</code>. Can we detect a difference in
treatment effect for conservative vs liberal individuals? For whom is
the effect larger? </font></p>
<p>複数のグループがあるときには、複数の仮説検定を行う必要がある。その場合はBonferroniの補正を行う必要がある。（少々保守的すぎるが）。補正はRのbaseに入っているp.adjustコマンドで出来る。</p>
<p>以下のコードでは、polyviews=1と比較して、全部の政治的志向ごとに異なるという仮説のもとで検定を実施し、補正を行う。</p>
<blockquote>
<p>Sometimes there are many subgroups, leading to multiple hypotheses
such as</p>
</blockquote>
<p><span class="math display">\[
H_0: \mathop{\mathrm{E}}[Y(1) - Y(0) \ | \  G_i = 1] = \mathop{\mathrm{E}}[Y(1) - Y(0) \ | \  G_i = g]
\qquad
\text{for many values of }g.
\]</span></p>
<blockquote>
<p>In that case, we need to correct for the fact that we are testing for
multiple hypotheses, or we will end up with many false positives. The
<strong>Bonferroni correction</strong>
<a href="https://en.wikipedia.org/wiki/Bonferroni_correction">(wiki)</a> is a
common method for dealing with multiple hypothesis testing, though it
is often too conservative to be useful. It is available via the
function <code>p.adjust</code> from base <code>R</code>. The next snippet of code tests
whether the treatment effect at each level of <code>polviews</code> is different
from the treatment effect from <code>polviews</code> equals one.</p>
</blockquote>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="heterogeneous-treatment-effect-1.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Only valid in randomized setting.</span></span>
<span id="cb47-2"><a href="heterogeneous-treatment-effect-1.html#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="heterogeneous-treatment-effect-1.html#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: these groups must be defined prior to collecting the data.</span></span>
<span id="cb47-4"><a href="heterogeneous-treatment-effect-1.html#cb47-4" aria-hidden="true" tabindex="-1"></a>group <span class="ot">&lt;-</span> <span class="st">&#39;polviews&#39;</span></span>
<span id="cb47-5"><a href="heterogeneous-treatment-effect-1.html#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="heterogeneous-treatment-effect-1.html#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear regression.</span></span>
<span id="cb47-7"><a href="heterogeneous-treatment-effect-1.html#cb47-7" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste</span>(outcome, <span class="st">&#39; ~ &#39;</span>, treatment, <span class="st">&#39;*&#39;</span>, <span class="st">&#39;factor(&#39;</span>, group, <span class="st">&#39;)&#39;</span>))</span>
<span id="cb47-8"><a href="heterogeneous-treatment-effect-1.html#cb47-8" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span>data)</span>
<span id="cb47-9"><a href="heterogeneous-treatment-effect-1.html#cb47-9" aria-hidden="true" tabindex="-1"></a>ols.res <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="at">type=</span><span class="st">&#39;HC2&#39;</span>))</span>
<span id="cb47-10"><a href="heterogeneous-treatment-effect-1.html#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="heterogeneous-treatment-effect-1.html#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve the interaction coefficients</span></span>
<span id="cb47-12"><a href="heterogeneous-treatment-effect-1.html#cb47-12" aria-hidden="true" tabindex="-1"></a>interact <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols)), <span class="cf">function</span>(x) <span class="fu">grepl</span>(<span class="st">&quot;w:&quot;</span>, x)))</span>
<span id="cb47-13"><a href="heterogeneous-treatment-effect-1.html#cb47-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-14"><a href="heterogeneous-treatment-effect-1.html#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve unadjusted p-values and </span></span>
<span id="cb47-15"><a href="heterogeneous-treatment-effect-1.html#cb47-15" aria-hidden="true" tabindex="-1"></a>unadj.p.value <span class="ot">&lt;-</span> ols.res[interact, <span class="dv">4</span>]</span>
<span id="cb47-16"><a href="heterogeneous-treatment-effect-1.html#cb47-16" aria-hidden="true" tabindex="-1"></a>adj.p.value <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(unadj.p.value, <span class="at">method=</span><span class="st">&#39;bonferroni&#39;</span>)</span>
<span id="cb47-17"><a href="heterogeneous-treatment-effect-1.html#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="heterogeneous-treatment-effect-1.html#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">estimate=</span><span class="fu">coef</span>(ols)[interact], <span class="at">std.err=</span>ols.res[interact,<span class="dv">2</span>], unadj.p.value, adj.p.value)</span></code></pre></div>
<pre><code>##                        estimate    std.err unadj.p.value  adj.p.value
## w:factor(polviews)2 -0.02424199 0.02733714  3.752056e-01 1.000000e+00
## w:factor(polviews)3 -0.05962335 0.02735735  2.930808e-02 1.758485e-01
## w:factor(polviews)4 -0.13461439 0.02534022  1.090684e-07 6.544105e-07
## w:factor(polviews)5 -0.16491540 0.02713505  1.235505e-09 7.413027e-09
## w:factor(polviews)6 -0.18007875 0.02751422  6.052625e-11 3.631575e-10
## w:factor(polviews)7 -0.18618443 0.03870554  1.514861e-06 9.089164e-06</code></pre>
<p>Romano-Wolfの補正というのもある。ブートストラップベースの手法で、最低限の仮定が用いられるため、こちらのほうが好まれる。</p>
<blockquote>
<p>Another option is to use the <strong>Romano-Wolf</strong> correction, based on
<a href="https://www.ssc.wisc.edu/~bhansen/718/RomanoWolf2005.pdf">Romano and Wolf (2005,
Econometrica)</a>.
This bootstrap-based procedure takes into account the underlying
dependence structure of the test statistics in a way that improves
power. The Romano-Wolf procedure is correct under minimal assumptions,
and should be favored over Bonferroni in general.</p>
</blockquote>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="heterogeneous-treatment-effect-1.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Auxiliary function to computes adjusted p-values </span></span>
<span id="cb49-2"><a href="heterogeneous-treatment-effect-1.html#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># following the Romano-Wolf method.</span></span>
<span id="cb49-3"><a href="heterogeneous-treatment-effect-1.html#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># For a reference, see http://ftp.iza.org/dp12845.pdf page 8</span></span>
<span id="cb49-4"><a href="heterogeneous-treatment-effect-1.html#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  t.orig: vector of t-statistics from original model</span></span>
<span id="cb49-5"><a href="heterogeneous-treatment-effect-1.html#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  t.boot: matrix of t-statistics from bootstrapped models</span></span>
<span id="cb49-6"><a href="heterogeneous-treatment-effect-1.html#cb49-6" aria-hidden="true" tabindex="-1"></a>romano_wolf_correction <span class="ot">&lt;-</span> <span class="cf">function</span>(t.orig, t.boot) {</span>
<span id="cb49-7"><a href="heterogeneous-treatment-effect-1.html#cb49-7" aria-hidden="true" tabindex="-1"></a>  abs.t.orig <span class="ot">&lt;-</span> <span class="fu">abs</span>(t.orig)</span>
<span id="cb49-8"><a href="heterogeneous-treatment-effect-1.html#cb49-8" aria-hidden="true" tabindex="-1"></a>  abs.t.boot <span class="ot">&lt;-</span> <span class="fu">abs</span>(t.boot)</span>
<span id="cb49-9"><a href="heterogeneous-treatment-effect-1.html#cb49-9" aria-hidden="true" tabindex="-1"></a>  abs.t.sorted <span class="ot">&lt;-</span> <span class="fu">sort</span>(abs.t.orig, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-10"><a href="heterogeneous-treatment-effect-1.html#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="heterogeneous-treatment-effect-1.html#cb49-11" aria-hidden="true" tabindex="-1"></a>  max.order <span class="ot">&lt;-</span> <span class="fu">order</span>(abs.t.orig, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-12"><a href="heterogeneous-treatment-effect-1.html#cb49-12" aria-hidden="true" tabindex="-1"></a>  rev.order <span class="ot">&lt;-</span> <span class="fu">order</span>(max.order)</span>
<span id="cb49-13"><a href="heterogeneous-treatment-effect-1.html#cb49-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-14"><a href="heterogeneous-treatment-effect-1.html#cb49-14" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">nrow</span>(t.boot)</span>
<span id="cb49-15"><a href="heterogeneous-treatment-effect-1.html#cb49-15" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">ncol</span>(t.boot)</span>
<span id="cb49-16"><a href="heterogeneous-treatment-effect-1.html#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="heterogeneous-treatment-effect-1.html#cb49-17" aria-hidden="true" tabindex="-1"></a>  p.adj <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, S)</span>
<span id="cb49-18"><a href="heterogeneous-treatment-effect-1.html#cb49-18" aria-hidden="true" tabindex="-1"></a>  p.adj[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">apply</span>(abs.t.boot, <span class="dv">1</span>, max) <span class="sc">&gt;</span> abs.t.sorted[<span class="dv">1</span>])</span>
<span id="cb49-19"><a href="heterogeneous-treatment-effect-1.html#cb49-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">2</span>, S)) {</span>
<span id="cb49-20"><a href="heterogeneous-treatment-effect-1.html#cb49-20" aria-hidden="true" tabindex="-1"></a>    cur.index <span class="ot">&lt;-</span> max.order[s<span class="sc">:</span>S]</span>
<span id="cb49-21"><a href="heterogeneous-treatment-effect-1.html#cb49-21" aria-hidden="true" tabindex="-1"></a>    p.init <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">apply</span>(abs.t.boot[, cur.index, <span class="at">drop=</span><span class="cn">FALSE</span>], <span class="dv">1</span>, max) <span class="sc">&gt;</span> abs.t.sorted[s])</span>
<span id="cb49-22"><a href="heterogeneous-treatment-effect-1.html#cb49-22" aria-hidden="true" tabindex="-1"></a>    p.adj[s] <span class="ot">&lt;-</span> <span class="fu">max</span>(p.init, p.adj[s<span class="dv">-1</span>])</span>
<span id="cb49-23"><a href="heterogeneous-treatment-effect-1.html#cb49-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-24"><a href="heterogeneous-treatment-effect-1.html#cb49-24" aria-hidden="true" tabindex="-1"></a>  p.adj[rev.order]</span>
<span id="cb49-25"><a href="heterogeneous-treatment-effect-1.html#cb49-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-26"><a href="heterogeneous-treatment-effect-1.html#cb49-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-27"><a href="heterogeneous-treatment-effect-1.html#cb49-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Computes adjusted p-values for linear regression (lm) models.</span></span>
<span id="cb49-28"><a href="heterogeneous-treatment-effect-1.html#cb49-28" aria-hidden="true" tabindex="-1"></a><span class="co">#    model: object of lm class (i.e., a linear reg model)</span></span>
<span id="cb49-29"><a href="heterogeneous-treatment-effect-1.html#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="co">#    indices: vector of integers for the coefficients that will be tested</span></span>
<span id="cb49-30"><a href="heterogeneous-treatment-effect-1.html#cb49-30" aria-hidden="true" tabindex="-1"></a><span class="co">#    cov.type: type of standard error (to be passed to sandwich::vcovHC)</span></span>
<span id="cb49-31"><a href="heterogeneous-treatment-effect-1.html#cb49-31" aria-hidden="true" tabindex="-1"></a><span class="co">#    num.boot: number of null bootstrap samples. Increase to stabilize across runs.</span></span>
<span id="cb49-32"><a href="heterogeneous-treatment-effect-1.html#cb49-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: results are probabilitistic and may change slightly at every run. </span></span>
<span id="cb49-33"><a href="heterogeneous-treatment-effect-1.html#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb49-34"><a href="heterogeneous-treatment-effect-1.html#cb49-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Adapted from the p_adjust from from the hdm package, written by Philipp Bach.</span></span>
<span id="cb49-35"><a href="heterogeneous-treatment-effect-1.html#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/PhilippBach/hdm_prev/blob/master/R/p_adjust.R</span></span>
<span id="cb49-36"><a href="heterogeneous-treatment-effect-1.html#cb49-36" aria-hidden="true" tabindex="-1"></a>summary_rw_lm <span class="ot">&lt;-</span> <span class="cf">function</span>(model, <span class="at">indices=</span><span class="cn">NULL</span>, <span class="at">cov.type=</span><span class="st">&quot;HC2&quot;</span>, <span class="at">num.boot=</span><span class="dv">10000</span>) {</span>
<span id="cb49-37"><a href="heterogeneous-treatment-effect-1.html#cb49-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-38"><a href="heterogeneous-treatment-effect-1.html#cb49-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(indices)) {</span>
<span id="cb49-39"><a href="heterogeneous-treatment-effect-1.html#cb49-39" aria-hidden="true" tabindex="-1"></a>    indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(<span class="fu">coef</span>(<span class="fu">summary</span>(model)))</span>
<span id="cb49-40"><a href="heterogeneous-treatment-effect-1.html#cb49-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-41"><a href="heterogeneous-treatment-effect-1.html#cb49-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Grab the original t values.</span></span>
<span id="cb49-42"><a href="heterogeneous-treatment-effect-1.html#cb49-42" aria-hidden="true" tabindex="-1"></a>  summary <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(model))[indices,,drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb49-43"><a href="heterogeneous-treatment-effect-1.html#cb49-43" aria-hidden="true" tabindex="-1"></a>  t.orig <span class="ot">&lt;-</span> summary[, <span class="st">&quot;t value&quot;</span>]</span>
<span id="cb49-44"><a href="heterogeneous-treatment-effect-1.html#cb49-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-45"><a href="heterogeneous-treatment-effect-1.html#cb49-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Null resampling.</span></span>
<span id="cb49-46"><a href="heterogeneous-treatment-effect-1.html#cb49-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is a trick to speed up bootstrapping linear models.</span></span>
<span id="cb49-47"><a href="heterogeneous-treatment-effect-1.html#cb49-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here, we don&#39;t really need to re-fit linear regressions, which would be a bit slow.</span></span>
<span id="cb49-48"><a href="heterogeneous-treatment-effect-1.html#cb49-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We know that betahat ~ N(beta, Sigma), and we have an estimate Sigmahat.</span></span>
<span id="cb49-49"><a href="heterogeneous-treatment-effect-1.html#cb49-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># So we can approximate &quot;null t-values&quot; by</span></span>
<span id="cb49-50"><a href="heterogeneous-treatment-effect-1.html#cb49-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  - Draw beta.boot ~ N(0, Sigma-hat) --- note the 0 here, this is what makes it a *null* t-value.</span></span>
<span id="cb49-51"><a href="heterogeneous-treatment-effect-1.html#cb49-51" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  - Compute t.boot = beta.boot / sqrt(diag(Sigma.hat))</span></span>
<span id="cb49-52"><a href="heterogeneous-treatment-effect-1.html#cb49-52" aria-hidden="true" tabindex="-1"></a>  Sigma.hat <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(model, <span class="at">type=</span>cov.type)[indices, indices]</span>
<span id="cb49-53"><a href="heterogeneous-treatment-effect-1.html#cb49-53" aria-hidden="true" tabindex="-1"></a>  se.orig <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(Sigma.hat))</span>
<span id="cb49-54"><a href="heterogeneous-treatment-effect-1.html#cb49-54" aria-hidden="true" tabindex="-1"></a>  num.coef <span class="ot">&lt;-</span> <span class="fu">length</span>(se.orig)</span>
<span id="cb49-55"><a href="heterogeneous-treatment-effect-1.html#cb49-55" aria-hidden="true" tabindex="-1"></a>  beta.boot <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="at">n=</span>num.boot, <span class="at">mu=</span><span class="fu">rep</span>(<span class="dv">0</span>, num.coef), <span class="at">Sigma=</span>Sigma.hat)</span>
<span id="cb49-56"><a href="heterogeneous-treatment-effect-1.html#cb49-56" aria-hidden="true" tabindex="-1"></a>  t.boot <span class="ot">&lt;-</span> <span class="fu">sweep</span>(beta.boot, <span class="dv">2</span>, se.orig, <span class="st">&quot;/&quot;</span>)</span>
<span id="cb49-57"><a href="heterogeneous-treatment-effect-1.html#cb49-57" aria-hidden="true" tabindex="-1"></a>  p.adj <span class="ot">&lt;-</span> <span class="fu">romano_wolf_correction</span>(t.orig, t.boot)</span>
<span id="cb49-58"><a href="heterogeneous-treatment-effect-1.html#cb49-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-59"><a href="heterogeneous-treatment-effect-1.html#cb49-59" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">cbind</span>(summary[,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>),<span class="at">drop=</span>F], p.adj)</span>
<span id="cb49-60"><a href="heterogeneous-treatment-effect-1.html#cb49-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(result) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Estimate&#39;</span>, <span class="st">&#39;Std. Error&#39;</span>, <span class="st">&#39;Orig. p-value&#39;</span>, <span class="st">&#39;Adj. p-value&#39;</span>)</span>
<span id="cb49-61"><a href="heterogeneous-treatment-effect-1.html#cb49-61" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb49-62"><a href="heterogeneous-treatment-effect-1.html#cb49-62" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="heterogeneous-treatment-effect-1.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This linear regression is only valid in a randomized setting.</span></span>
<span id="cb50-2"><a href="heterogeneous-treatment-effect-1.html#cb50-2" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste</span>(outcome, <span class="st">&#39; ~ &#39;</span>, treatment, <span class="st">&#39;*&#39;</span>, <span class="st">&#39;factor(&#39;</span>, group, <span class="st">&#39;)&#39;</span>))</span>
<span id="cb50-3"><a href="heterogeneous-treatment-effect-1.html#cb50-3" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span>data)</span>
<span id="cb50-4"><a href="heterogeneous-treatment-effect-1.html#cb50-4" aria-hidden="true" tabindex="-1"></a>interact <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols)), <span class="cf">function</span>(x) <span class="fu">grepl</span>(<span class="fu">paste0</span>(treatment, <span class="st">&quot;:&quot;</span>), x)))</span>
<span id="cb50-5"><a href="heterogeneous-treatment-effect-1.html#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="heterogeneous-treatment-effect-1.html#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying the romano-wolf correction.</span></span>
<span id="cb50-7"><a href="heterogeneous-treatment-effect-1.html#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span>interact)</span></code></pre></div>
<pre><code>##                        Estimate Std. Error Orig. p-value Adj. p-value
## w:factor(polviews)2 -0.02424199 0.03034779  4.244098e-01       0.4271
## w:factor(polviews)3 -0.05962335 0.03015010  4.798896e-02       0.0768
## w:factor(polviews)4 -0.13461439 0.02822807  1.862258e-06       0.0000
## w:factor(polviews)5 -0.16491540 0.02957511  2.481093e-08       0.0000
## w:factor(polviews)6 -0.18007875 0.02966030  1.284150e-09       0.0000
## w:factor(polviews)7 -0.18618443 0.03790379  9.063658e-07       0.0000</code></pre>
<p><font size=1> Compare the adjusted p-values under Romano-Wolf with those
obtained via Bonferroni above. </font></p>
<p>Bonferroni補正とRomano-Wolfの補正は、<strong>familywise error rate
(FWER)</strong>をコントロールする。これは、真である帰無仮説を一つでも棄却してしま確率である。（メモ：真である帰無仮説を誤って棄却してしまう確率＝Type
I
error＝αをコントロールする）。言い換えると、有意水準αのもと、1-αの確率で全くFalseDiscoveryしないで済むことになる。しかし、仮説検定の数が増えると、この基準は強すぎて真の効果を見落としてしまいかねない。</p>
<p>そこで代わりに、<strong>false discovery rate
(FDR)</strong>をコントロールする補正が使われることもある。これは、棄却されたすべての帰無仮説のうちの実際には真であった帰無仮説の割合の期待値を表している。FDRはBenjamini-Hochberg
の手法で補正でき、base R では
<code>p.adjust(..., method="BH")</code>.コマンドで実装できる。</p>
<p>以下ではFWERによる調整で基本的に進めるが、FDRによる調整も有用であり、特に検討中の仮説の数が非常に多い探索的な分析においては、有用であることを覚えておきたい。</p>
<blockquote>
<p>The Bonferroni and Romano-Wolf methods control the <strong>familywise error
rate (FWER)</strong>, which is the (asymptotic) probability of rejecting even
one true null hypothesis. In other words, for a significance level
<span class="math inline">\(\alpha\)</span>, they guarantee that with probability <span class="math inline">\(1 - \alpha\)</span> we will
make zero false discoveries. However, when the number of hypotheses
being tested is very large, this criterion may be so stringent that it
prevents us from being able to detect real effects. Instead, there
exist alternative procedures that control the (asymptotic) <strong>false
discovery rate (FDR)</strong>, defined as the expected proportion of true
null hypotheses rejected among all hypotheses rejected. One such
procedure is the Benjamini-Hochberg procedure, which is available in
base R via <code>p.adjust(..., method="BH")</code>. For what remains we’ll stick
with FWER control, but keep in mind that FDR control can also useful
in exploratory analyses or settings in which there’s a very large
number of hypotheses under consideration.</p>
</blockquote>
<p>前章と同様に、unconfoundednessとoverlapのもとで観察データを扱う場合には、AIPWスコア
<span class="math inline">\(\widehat{\Gamma}_i\)</span> を生のアウトカム
<span class="math inline">\(Y_i\)</span>の代わりに使うこともできる。以下のコードでは、<code>grf</code> パッケージの
<code>causal_forest</code> を使ってAIPWスコアを構築する。</p>
<p>（メモ：観察データを使う場合、処置が観察可能なデータで説明できるのであれば、属性による処置効果の違いは交差項を入れることで対応できない。したがって、causal
forest関数を使って、アウトカムモデルと処置の予測モデルを作ることで、AIPW＝Doubly
Robustを作るということ。）</p>
<p><img src="C:/Users/root1/AppData/Local/RStudio/tmp/paste-BF3A5D95.png" /></p>
<blockquote>
<p>As in the previous chapter, when working with observational data under
unconfoundedness and overlap, one can use AIPW scores
<span class="math inline">\(\widehat{\Gamma}_i\)</span> in place of the raw outcomes <span class="math inline">\(Y_i\)</span>. In the next
snippet, we construct AIPW scores using the <code>causal_forest</code> function
from the <code>grf</code> package.</p>
</blockquote>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="heterogeneous-treatment-effect-1.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid in randomized settings and observational settings with unconfoundedness+overlap.</span></span>
<span id="cb52-2"><a href="heterogeneous-treatment-effect-1.html#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="heterogeneous-treatment-effect-1.html#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparing data to fit a causal forest</span></span>
<span id="cb52-4"><a href="heterogeneous-treatment-effect-1.html#cb52-4" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~ 0 +&quot;</span>, <span class="fu">paste0</span>(covariates, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)))</span>
<span id="cb52-5"><a href="heterogeneous-treatment-effect-1.html#cb52-5" aria-hidden="true" tabindex="-1"></a>XX <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla, data)</span>
<span id="cb52-6"><a href="heterogeneous-treatment-effect-1.html#cb52-6" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> data[,treatment]</span>
<span id="cb52-7"><a href="heterogeneous-treatment-effect-1.html#cb52-7" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> data[,outcome]</span>
<span id="cb52-8"><a href="heterogeneous-treatment-effect-1.html#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="heterogeneous-treatment-effect-1.html#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Comment or uncomment as appropriate.</span></span>
<span id="cb52-10"><a href="heterogeneous-treatment-effect-1.html#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Randomized setting with known and fixed probabilities (here: 0.5).</span></span>
<span id="cb52-11"><a href="heterogeneous-treatment-effect-1.html#cb52-11" aria-hidden="true" tabindex="-1"></a>forest.tau <span class="ot">&lt;-</span> <span class="fu">causal_forest</span>(XX, Y, W, <span class="at">W.hat=</span>.<span class="dv">5</span>) </span>
<span id="cb52-12"><a href="heterogeneous-treatment-effect-1.html#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Observational setting with unconf + overlap, unknown assignment probs.</span></span>
<span id="cb52-13"><a href="heterogeneous-treatment-effect-1.html#cb52-13" aria-hidden="true" tabindex="-1"></a>forest.tau <span class="ot">&lt;-</span> <span class="fu">causal_forest</span>(XX, Y, W) </span>
<span id="cb52-14"><a href="heterogeneous-treatment-effect-1.html#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="heterogeneous-treatment-effect-1.html#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Get forest predictions. </span></span>
<span id="cb52-16"><a href="heterogeneous-treatment-effect-1.html#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="co"># eは傾向スコアの推定値</span></span>
<span id="cb52-17"><a href="heterogeneous-treatment-effect-1.html#cb52-17" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest.tau)<span class="sc">$</span>predictions </span>
<span id="cb52-18"><a href="heterogeneous-treatment-effect-1.html#cb52-18" aria-hidden="true" tabindex="-1"></a>m.hat <span class="ot">&lt;-</span> forest.tau<span class="sc">$</span>Y.hat  <span class="co"># E[Y|X] estimates</span></span>
<span id="cb52-19"><a href="heterogeneous-treatment-effect-1.html#cb52-19" aria-hidden="true" tabindex="-1"></a>e.hat <span class="ot">&lt;-</span> forest.tau<span class="sc">$</span>W.hat  <span class="co"># e(X) := E[W|X] estimates (or known quantity)　</span></span>
<span id="cb52-20"><a href="heterogeneous-treatment-effect-1.html#cb52-20" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> forest.tau<span class="sc">$</span>predictions  <span class="co"># tau(X) estimates</span></span>
<span id="cb52-21"><a href="heterogeneous-treatment-effect-1.html#cb52-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-22"><a href="heterogeneous-treatment-effect-1.html#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicting mu.hat(X[i], 1) and mu.hat(X[i], 0) for obs in held-out sample</span></span>
<span id="cb52-23"><a href="heterogeneous-treatment-effect-1.html#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: to understand this, read equations 6-8 in this vignette</span></span>
<span id="cb52-24"><a href="heterogeneous-treatment-effect-1.html#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="co"># https://grf-labs.github.io/grf/articles/muhats.html</span></span>
<span id="cb52-25"><a href="heterogeneous-treatment-effect-1.html#cb52-25" aria-hidden="true" tabindex="-1"></a><span class="co"># muはアウトカムモデル。Y-e*tau mu(X,w)</span></span>
<span id="cb52-26"><a href="heterogeneous-treatment-effect-1.html#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Held out sampleを切り出してなくない？</span></span>
<span id="cb52-27"><a href="heterogeneous-treatment-effect-1.html#cb52-27" aria-hidden="true" tabindex="-1"></a>mu.hat<span class="fl">.0</span> <span class="ot">&lt;-</span> m.hat <span class="sc">-</span> e.hat <span class="sc">*</span> tau.hat        <span class="co"># E[Y|X,W=0] = E[Y|X] - e(X)*tau(X)</span></span>
<span id="cb52-28"><a href="heterogeneous-treatment-effect-1.html#cb52-28" aria-hidden="true" tabindex="-1"></a>mu.hat<span class="fl">.1</span> <span class="ot">&lt;-</span> m.hat <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> e.hat) <span class="sc">*</span> tau.hat  <span class="co"># E[Y|X,W=1] = E[Y|X] + (1 - e(X))*tau(X)</span></span>
<span id="cb52-29"><a href="heterogeneous-treatment-effect-1.html#cb52-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-30"><a href="heterogeneous-treatment-effect-1.html#cb52-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute AIPW scores</span></span>
<span id="cb52-31"><a href="heterogeneous-treatment-effect-1.html#cb52-31" aria-hidden="true" tabindex="-1"></a>aipw.scores <span class="ot">&lt;-</span> tau.hat <span class="sc">+</span> W <span class="sc">/</span> e.hat <span class="sc">*</span> (Y <span class="sc">-</span>  mu.hat<span class="fl">.1</span>) <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> W) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> e.hat) <span class="sc">*</span> (Y <span class="sc">-</span>  mu.hat<span class="fl">.0</span>)</span>
<span id="cb52-32"><a href="heterogeneous-treatment-effect-1.html#cb52-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-33"><a href="heterogeneous-treatment-effect-1.html#cb52-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate average treatment effect conditional on group membership</span></span>
<span id="cb52-34"><a href="heterogeneous-treatment-effect-1.html#cb52-34" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&#39;aipw.scores ~ factor(&#39;</span>, group, <span class="st">&#39;)&#39;</span>))</span>
<span id="cb52-35"><a href="heterogeneous-treatment-effect-1.html#cb52-35" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data, <span class="at">aipw.scores=</span>aipw.scores))</span>
<span id="cb52-36"><a href="heterogeneous-treatment-effect-1.html#cb52-36" aria-hidden="true" tabindex="-1"></a>ols.res <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols, <span class="at">vcov =</span> <span class="fu">vcovHC</span>(ols, <span class="st">&quot;HC2&quot;</span>))</span>
<span id="cb52-37"><a href="heterogeneous-treatment-effect-1.html#cb52-37" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols.res)) <span class="sc">!=</span> <span class="st">&#39;(Intercept)&#39;</span>)</span>
<span id="cb52-38"><a href="heterogeneous-treatment-effect-1.html#cb52-38" aria-hidden="true" tabindex="-1"></a><span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span>indices)</span></code></pre></div>
<pre><code>##                      Estimate Std. Error Orig. p-value Adj. p-value
## factor(polviews)2 -0.02731358 0.03214989  3.955714e-01       0.3984
## factor(polviews)3 -0.07240373 0.03194569  2.343048e-02       0.0362
## factor(polviews)4 -0.13998995 0.02992254  2.904263e-06       0.0001
## factor(polviews)5 -0.17606994 0.03134611  1.961449e-08       0.0000
## factor(polviews)6 -0.18089630 0.03143628  8.784603e-09       0.0000
## factor(polviews)7 -0.20001443 0.04013912  6.296079e-07       0.0000</code></pre>
<p>ほかのノンパラメトリック手法でAIPWスコアを作ることもできる。ここでは、<code>glmnet</code>
と
<code>splines</code>関数によって柔軟な一般化線形モデルを使った場合の方法をいかに示す。</p>
<blockquote>
<p>One can also construct AIPW scores using any other nonparametric
method. Here’s how to do it by fitting flexible generalized linear
models <code>glmnet</code> and <code>splines</code>.</p>
</blockquote>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="heterogeneous-treatment-effect-1.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid randomized data and observational data with unconfoundedness+overlap.</span></span>
<span id="cb54-2"><a href="heterogeneous-treatment-effect-1.html#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: read the comments below carefully. </span></span>
<span id="cb54-3"><a href="heterogeneous-treatment-effect-1.html#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co"># In randomized settings, do not estimate forest.e and e.hat; use known assignment probs.</span></span>
<span id="cb54-4"><a href="heterogeneous-treatment-effect-1.html#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># forest云々は記載ミスか。</span></span>
<span id="cb54-5"><a href="heterogeneous-treatment-effect-1.html#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># bs はsplineパッケージに入っているノンパラ関数</span></span>
<span id="cb54-6"><a href="heterogeneous-treatment-effect-1.html#cb54-6" aria-hidden="true" tabindex="-1"></a>fmla.xw <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;bs(&quot;</span>, covariates, <span class="st">&quot;, df=3, degree=3) *&quot;</span>, treatment, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)))</span>
<span id="cb54-7"><a href="heterogeneous-treatment-effect-1.html#cb54-7" aria-hidden="true" tabindex="-1"></a>fmla.x <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;bs(&quot;</span>, covariates, <span class="st">&quot;, df=3, degree=3)&quot;</span>, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)))</span>
<span id="cb54-8"><a href="heterogeneous-treatment-effect-1.html#cb54-8" aria-hidden="true" tabindex="-1"></a>XW <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla.xw, data)</span>
<span id="cb54-9"><a href="heterogeneous-treatment-effect-1.html#cb54-9" aria-hidden="true" tabindex="-1"></a>XX <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla.x, data)</span>
<span id="cb54-10"><a href="heterogeneous-treatment-effect-1.html#cb54-10" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> data[,outcome]</span>
<span id="cb54-11"><a href="heterogeneous-treatment-effect-1.html#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="heterogeneous-treatment-effect-1.html#cb54-12" aria-hidden="true" tabindex="-1"></a>n.folds <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb54-13"><a href="heterogeneous-treatment-effect-1.html#cb54-13" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">split</span>(<span class="fu">seq</span>(n), <span class="fu">sort</span>(<span class="fu">seq</span>(n) <span class="sc">%%</span> n.folds))</span>
<span id="cb54-14"><a href="heterogeneous-treatment-effect-1.html#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="heterogeneous-treatment-effect-1.html#cb54-15" aria-hidden="true" tabindex="-1"></a>aipw.scores <span class="ot">&lt;-</span> <span class="fu">lapply</span>(indices, <span class="cf">function</span>(idx) {</span>
<span id="cb54-16"><a href="heterogeneous-treatment-effect-1.html#cb54-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-17"><a href="heterogeneous-treatment-effect-1.html#cb54-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fitting the outcome model</span></span>
<span id="cb54-18"><a href="heterogeneous-treatment-effect-1.html#cb54-18" aria-hidden="true" tabindex="-1"></a>  model.m <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(XW[<span class="sc">-</span>idx,], Y[<span class="sc">-</span>idx])  </span>
<span id="cb54-19"><a href="heterogeneous-treatment-effect-1.html#cb54-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-20"><a href="heterogeneous-treatment-effect-1.html#cb54-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict outcome E[Y|X,W=w] for w in {0, 1}</span></span>
<span id="cb54-21"><a href="heterogeneous-treatment-effect-1.html#cb54-21" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.0</span> <span class="ot">&lt;-</span> data</span>
<span id="cb54-22"><a href="heterogeneous-treatment-effect-1.html#cb54-22" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.0</span>[,treatment] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-23"><a href="heterogeneous-treatment-effect-1.html#cb54-23" aria-hidden="true" tabindex="-1"></a>  XW0 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla.xw, data<span class="fl">.0</span>)</span>
<span id="cb54-24"><a href="heterogeneous-treatment-effect-1.html#cb54-24" aria-hidden="true" tabindex="-1"></a>  mu.hat<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="fu">predict</span>(model.m, XW0, <span class="at">s=</span><span class="st">&quot;lambda.min&quot;</span>)[idx,]</span>
<span id="cb54-25"><a href="heterogeneous-treatment-effect-1.html#cb54-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-26"><a href="heterogeneous-treatment-effect-1.html#cb54-26" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.1</span> <span class="ot">&lt;-</span> data</span>
<span id="cb54-27"><a href="heterogeneous-treatment-effect-1.html#cb54-27" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.1</span>[,treatment] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-28"><a href="heterogeneous-treatment-effect-1.html#cb54-28" aria-hidden="true" tabindex="-1"></a>  XW1 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla.xw, data<span class="fl">.1</span>)</span>
<span id="cb54-29"><a href="heterogeneous-treatment-effect-1.html#cb54-29" aria-hidden="true" tabindex="-1"></a>  mu.hat<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">predict</span>(model.m, XW1, <span class="at">s=</span><span class="st">&quot;lambda.min&quot;</span>)[idx,]</span>
<span id="cb54-30"><a href="heterogeneous-treatment-effect-1.html#cb54-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-31"><a href="heterogeneous-treatment-effect-1.html#cb54-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fitting the propensity score model</span></span>
<span id="cb54-32"><a href="heterogeneous-treatment-effect-1.html#cb54-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Comment / uncomment the lines below as appropriate.</span></span>
<span id="cb54-33"><a href="heterogeneous-treatment-effect-1.html#cb54-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># OBSERVATIONAL SETTING (with unconfoundedness+overlap):</span></span>
<span id="cb54-34"><a href="heterogeneous-treatment-effect-1.html#cb54-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># model.e &lt;- cv.glmnet(XX[-idx,], W[-idx], family=&quot;binomial&quot;)  </span></span>
<span id="cb54-35"><a href="heterogeneous-treatment-effect-1.html#cb54-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># e.hat &lt;- predict(model.e, XX[idx,], s=&quot;lambda.min&quot;, type=&quot;response&quot;)</span></span>
<span id="cb54-36"><a href="heterogeneous-treatment-effect-1.html#cb54-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RANDOMIZED SETTING</span></span>
<span id="cb54-37"><a href="heterogeneous-treatment-effect-1.html#cb54-37" aria-hidden="true" tabindex="-1"></a>  e.hat <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.5</span>, <span class="fu">length</span>(idx))  </span>
<span id="cb54-38"><a href="heterogeneous-treatment-effect-1.html#cb54-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-39"><a href="heterogeneous-treatment-effect-1.html#cb54-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute CATE estimates</span></span>
<span id="cb54-40"><a href="heterogeneous-treatment-effect-1.html#cb54-40" aria-hidden="true" tabindex="-1"></a>  tau.hat <span class="ot">&lt;-</span> mu.hat<span class="fl">.1</span> <span class="sc">-</span> mu.hat<span class="fl">.0</span></span>
<span id="cb54-41"><a href="heterogeneous-treatment-effect-1.html#cb54-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-42"><a href="heterogeneous-treatment-effect-1.html#cb54-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute AIPW scores</span></span>
<span id="cb54-43"><a href="heterogeneous-treatment-effect-1.html#cb54-43" aria-hidden="true" tabindex="-1"></a>  aipw.scores <span class="ot">&lt;-</span> (tau.hat </span>
<span id="cb54-44"><a href="heterogeneous-treatment-effect-1.html#cb54-44" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">+</span> W[idx] <span class="sc">/</span> e.hat <span class="sc">*</span> (Y[idx] <span class="sc">-</span>  mu.hat<span class="fl">.1</span>)</span>
<span id="cb54-45"><a href="heterogeneous-treatment-effect-1.html#cb54-45" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> W[idx]) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> e.hat) <span class="sc">*</span> (Y[idx] <span class="sc">-</span>  mu.hat<span class="fl">.0</span>))</span>
<span id="cb54-46"><a href="heterogeneous-treatment-effect-1.html#cb54-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-47"><a href="heterogeneous-treatment-effect-1.html#cb54-47" aria-hidden="true" tabindex="-1"></a>  aipw.scores</span>
<span id="cb54-48"><a href="heterogeneous-treatment-effect-1.html#cb54-48" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb54-49"><a href="heterogeneous-treatment-effect-1.html#cb54-49" aria-hidden="true" tabindex="-1"></a>aipw.scores<span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">do.call</span>(c, aipw.scores))</span>
<span id="cb54-50"><a href="heterogeneous-treatment-effect-1.html#cb54-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-51"><a href="heterogeneous-treatment-effect-1.html#cb54-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate average treatment effect conditional on group membership</span></span>
<span id="cb54-52"><a href="heterogeneous-treatment-effect-1.html#cb54-52" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&#39;aipw.scores ~ factor(&#39;</span>, group, <span class="st">&#39;)&#39;</span>))</span>
<span id="cb54-53"><a href="heterogeneous-treatment-effect-1.html#cb54-53" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data, <span class="at">aipw.scores=</span>aipw.scores))</span>
<span id="cb54-54"><a href="heterogeneous-treatment-effect-1.html#cb54-54" aria-hidden="true" tabindex="-1"></a>ols.res <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols, <span class="at">vcov =</span> <span class="fu">vcovHC</span>(ols, <span class="st">&quot;HC2&quot;</span>))</span>
<span id="cb54-55"><a href="heterogeneous-treatment-effect-1.html#cb54-55" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols.res)) <span class="sc">!=</span> <span class="st">&#39;(Intercept)&#39;</span>)</span>
<span id="cb54-56"><a href="heterogeneous-treatment-effect-1.html#cb54-56" aria-hidden="true" tabindex="-1"></a><span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span>indices)</span></code></pre></div>
<pre><code>##                      Estimate Std. Error Orig. p-value Adj. p-value
## factor(polviews)2 -0.02431188 0.03025159  4.216022e-01       0.4196
## factor(polviews)3 -0.06078026 0.03005945  4.318542e-02       0.0716
## factor(polviews)4 -0.13363032 0.02815576  2.083662e-06       0.0000
## factor(polviews)5 -0.16498404 0.02949527  2.244685e-08       0.0000
## factor(polviews)6 -0.17926620 0.02958012  1.375097e-09       0.0000
## factor(polviews)7 -0.18695392 0.03776909  7.466598e-07       0.0000</code></pre>
</div>
<div id="data-driven-hypotheses" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Data-driven hypotheses</h2>
<p>データを見る前にあらかじめ検証する仮説を決めておくことはp-cackingを避ける意味でも良いプラクティスである。ただし、有効な検定はsample
splittingを行うことでもできる。sample splitting
とは、よさそうなサブグループを見つけるためにデータの一部を用い、そのあと残りのサンプルを使ってこれらのサブグループに関する仮説検定を行う。このような仮説検定のためのサンプル分割は<strong>honesty</strong>と呼ばれる。</p>
<blockquote>
<p>Pre-specifying hypotheses prior to looking at the data is in general
good practice to avoid “p-hacking” (e.g., slicing the data into
different subgroups until a significant result is found). However,
valid tests can also be attained if by <strong>sample splitting</strong>: we can
use a subset of the sample to find promising subgroups, then test
hypotheses about these subgroups in the remaining sample. This kind of
sample splitting for hypothesis testing is called <strong>honesty</strong>.</p>
</blockquote>
<div id="via-causal-trees" class="section level3" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Via causal trees</h3>
<p>Causal
treeはランダム化を前提として処置効果が異なるサブグループを見つけることができる直感的なアルゴリズムである。</p>
<p>考え方としては、サンプルを<code>splitting</code>、<code>estimation</code>、<code>test</code>にの3つに分割する（必ずしも同じ数のサンプル出なくてよい）。splittingは、決定木をフィットさせるのに使い、葉ごとの処置効果の差が最大になるように推定される。estimationサンプルは、それぞれの葉の処置効果を推定するために使われる。testサンプルは、木の推定値のヴァリデーションに使われる。</p>
<blockquote>
<p><strong>Causal trees</strong> <a href="https://www.pnas.org/content/pnas/113/27/7353.full.pdf">(Athey and Imbens)(PNAS,
2016)</a> are an
intuitive algorithm that is available in the randomized setting to
discover subgroups with different treatment effects.</p>
<p>At a high level, the idea is to divide the sample into three subsets
(not necessarily of equal size). The <code>splitting</code> subset is used to fit
a decision tree whose objective is modified to maximize heterogeneity
in treatment effect estimates across leaves. The <code>estimation</code> subset
is then used to produce a valid estimate of the treatment effect at
each leaf of the fitted tree. Finally, a <code>test</code> subset can be used to
validate the tree estimates.</p>
</blockquote>
<p>The next snippet uses <code>honest.causalTree</code> function from the
<a href="https://github.com/susanathey/causalTree"><code>causalTree</code></a> package. For
more details, see the <a href="https://github.com/susanathey/causalTree/blob/master/briefintro.pdf">causalTree
documentation</a>.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="heterogeneous-treatment-effect-1.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Only valid for randomized data!</span></span>
<span id="cb56-2"><a href="heterogeneous-treatment-effect-1.html#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="heterogeneous-treatment-effect-1.html#cb56-3" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">paste</span>(outcome, <span class="st">&quot; ~&quot;</span>, <span class="fu">paste</span>(covariates, <span class="at">collapse =</span> <span class="st">&quot; + &quot;</span>))</span>
<span id="cb56-4"><a href="heterogeneous-treatment-effect-1.html#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="heterogeneous-treatment-effect-1.html#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Dividing data into three subsets</span></span>
<span id="cb56-6"><a href="heterogeneous-treatment-effect-1.html#cb56-6" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">split</span>(<span class="fu">seq</span>(<span class="fu">nrow</span>(data)), <span class="fu">sort</span>(<span class="fu">seq</span>(<span class="fu">nrow</span>(data)) <span class="sc">%%</span> <span class="dv">3</span>))</span>
<span id="cb56-7"><a href="heterogeneous-treatment-effect-1.html#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(indices) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;split&#39;</span>, <span class="st">&#39;est&#39;</span>, <span class="st">&#39;test&#39;</span>)</span>
<span id="cb56-8"><a href="heterogeneous-treatment-effect-1.html#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="heterogeneous-treatment-effect-1.html#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting the forest</span></span>
<span id="cb56-10"><a href="heterogeneous-treatment-effect-1.html#cb56-10" aria-hidden="true" tabindex="-1"></a>ct.unpruned <span class="ot">&lt;-</span> <span class="fu">honest.causalTree</span>(</span>
<span id="cb56-11"><a href="heterogeneous-treatment-effect-1.html#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula=</span>fmla,            <span class="co"># Define the model</span></span>
<span id="cb56-12"><a href="heterogeneous-treatment-effect-1.html#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data=</span>data[indices<span class="sc">$</span>split,],</span>
<span id="cb56-13"><a href="heterogeneous-treatment-effect-1.html#cb56-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment=</span>data[indices<span class="sc">$</span>split, treatment],</span>
<span id="cb56-14"><a href="heterogeneous-treatment-effect-1.html#cb56-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">est_data=</span>data[indices<span class="sc">$</span>est,],</span>
<span id="cb56-15"><a href="heterogeneous-treatment-effect-1.html#cb56-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">est_treatment=</span>data[indices<span class="sc">$</span>est, treatment],</span>
<span id="cb56-16"><a href="heterogeneous-treatment-effect-1.html#cb56-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">minsize=</span><span class="dv">1</span>,                 <span class="co"># Min. number of treatment and control cases in each leaf</span></span>
<span id="cb56-17"><a href="heterogeneous-treatment-effect-1.html#cb56-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">HonestSampleSize=</span><span class="fu">length</span>(indices<span class="sc">$</span>est), <span class="co">#  Num obs used in estimation after splitting</span></span>
<span id="cb56-18"><a href="heterogeneous-treatment-effect-1.html#cb56-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We recommend not changing the parameters below</span></span>
<span id="cb56-19"><a href="heterogeneous-treatment-effect-1.html#cb56-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">split.Rule=</span><span class="st">&quot;CT&quot;</span>,            <span class="co"># Define the splitting option</span></span>
<span id="cb56-20"><a href="heterogeneous-treatment-effect-1.html#cb56-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv.option=</span><span class="st">&quot;TOT&quot;</span>,            <span class="co"># Cross validation options</span></span>
<span id="cb56-21"><a href="heterogeneous-treatment-effect-1.html#cb56-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">cp=</span><span class="dv">0</span>,                       <span class="co"># Complexity parameter</span></span>
<span id="cb56-22"><a href="heterogeneous-treatment-effect-1.html#cb56-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">split.Honest=</span><span class="cn">TRUE</span>,          <span class="co"># Use honesty when splitting</span></span>
<span id="cb56-23"><a href="heterogeneous-treatment-effect-1.html#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv.Honest=</span><span class="cn">TRUE</span>              <span class="co"># Use honesty when performing cross-validation</span></span>
<span id="cb56-24"><a href="heterogeneous-treatment-effect-1.html#cb56-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-25"><a href="heterogeneous-treatment-effect-1.html#cb56-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-26"><a href="heterogeneous-treatment-effect-1.html#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Table of cross-validated values by tuning parameter.</span></span>
<span id="cb56-27"><a href="heterogeneous-treatment-effect-1.html#cb56-27" aria-hidden="true" tabindex="-1"></a>ct.cptable <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(ct.unpruned<span class="sc">$</span>cptable)</span>
<span id="cb56-28"><a href="heterogeneous-treatment-effect-1.html#cb56-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-29"><a href="heterogeneous-treatment-effect-1.html#cb56-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain optimal complexity parameter to prune tree.</span></span>
<span id="cb56-30"><a href="heterogeneous-treatment-effect-1.html#cb56-30" aria-hidden="true" tabindex="-1"></a>cp.selected <span class="ot">&lt;-</span> <span class="fu">which.min</span>(ct.cptable<span class="sc">$</span>xerror)</span>
<span id="cb56-31"><a href="heterogeneous-treatment-effect-1.html#cb56-31" aria-hidden="true" tabindex="-1"></a>cp.optimal <span class="ot">&lt;-</span> ct.cptable[cp.selected, <span class="st">&quot;CP&quot;</span>]</span>
<span id="cb56-32"><a href="heterogeneous-treatment-effect-1.html#cb56-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-33"><a href="heterogeneous-treatment-effect-1.html#cb56-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Prune the tree at optimal complexity parameter.</span></span>
<span id="cb56-34"><a href="heterogeneous-treatment-effect-1.html#cb56-34" aria-hidden="true" tabindex="-1"></a>ct.pruned <span class="ot">&lt;-</span> <span class="fu">prune</span>(<span class="at">tree=</span>ct.unpruned, <span class="at">cp=</span>cp.optimal)</span>
<span id="cb56-35"><a href="heterogeneous-treatment-effect-1.html#cb56-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-36"><a href="heterogeneous-treatment-effect-1.html#cb56-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict point estimates (on estimation sample)</span></span>
<span id="cb56-37"><a href="heterogeneous-treatment-effect-1.html#cb56-37" aria-hidden="true" tabindex="-1"></a>tau.hat.est <span class="ot">&lt;-</span> <span class="fu">predict</span>(ct.pruned, <span class="at">newdata=</span>data[indices<span class="sc">$</span>est,])</span>
<span id="cb56-38"><a href="heterogeneous-treatment-effect-1.html#cb56-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-39"><a href="heterogeneous-treatment-effect-1.html#cb56-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a factor column &#39;leaf&#39; indicating leaf assignment in the estimation set</span></span>
<span id="cb56-40"><a href="heterogeneous-treatment-effect-1.html#cb56-40" aria-hidden="true" tabindex="-1"></a>num.leaves <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(tau.hat.est))</span>
<span id="cb56-41"><a href="heterogeneous-treatment-effect-1.html#cb56-41" aria-hidden="true" tabindex="-1"></a>leaf <span class="ot">&lt;-</span> <span class="fu">factor</span>(tau.hat.est, <span class="at">levels=</span><span class="fu">sort</span>(<span class="fu">unique</span>(tau.hat.est)), <span class="at">labels =</span> <span class="fu">seq</span>(num.leaves))</span></code></pre></div>
<p>注：まったく木が分割しない場合には、各葉の最小サンプル数を調整するパラメータであるminsizeを減らすと良い。以下のコードではTreeを描画する。セルの中の値は処置効果の推定値と、各葉に落ちるサンプルの割合の推定値をあらわしている。これらはestimationサンプルを使って推定されている。</p>
<blockquote>
<p>Note: if your tree is not splitting at all, try decreasing the
parameter <code>minsize</code> that controls the minimum size of each leaf. The
next snippet plots the learned tree. The values in the cell are the
estimated treatment effect and an estimate of the fraction of the
population that falls within each leaf. Both are estimated using the
<code>estimation</code> sample.</p>
</blockquote>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="heterogeneous-treatment-effect-1.html#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(</span>
<span id="cb57-2"><a href="heterogeneous-treatment-effect-1.html#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x=</span>ct.pruned,        <span class="co"># Pruned tree</span></span>
<span id="cb57-3"><a href="heterogeneous-treatment-effect-1.html#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type=</span><span class="dv">3</span>,             <span class="co"># Draw separate split labels for the left and right directions</span></span>
<span id="cb57-4"><a href="heterogeneous-treatment-effect-1.html#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fallen=</span><span class="cn">TRUE</span>,        <span class="co"># Position the leaf nodes at the bottom of the graph</span></span>
<span id="cb57-5"><a href="heterogeneous-treatment-effect-1.html#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">leaf.round=</span><span class="dv">1</span>,       <span class="co"># Rounding of the corners of the leaf node boxes</span></span>
<span id="cb57-6"><a href="heterogeneous-treatment-effect-1.html#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">extra=</span><span class="dv">100</span>,          <span class="co"># Display the percentage of observations in the node</span></span>
<span id="cb57-7"><a href="heterogeneous-treatment-effect-1.html#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">branch=</span>.<span class="dv">1</span>,          <span class="co"># Shape of the branch lines</span></span>
<span id="cb57-8"><a href="heterogeneous-treatment-effect-1.html#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">box.palette=</span><span class="st">&quot;RdBu&quot;</span>) <span class="co"># Palette for coloring the node</span></span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<p>The next snippet tests if the treatment effect in leaves <span class="math inline">\(\geq 2\)</span> is
larger than the treatment effect in the first leaf. The code follows
closely what we saw in the previous subsection.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="heterogeneous-treatment-effect-1.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is only valid in randomized datasets.</span></span>
<span id="cb58-2"><a href="heterogeneous-treatment-effect-1.html#cb58-2" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">paste0</span>(outcome, <span class="st">&#39; ~ &#39;</span>, <span class="fu">paste0</span>(treatment, <span class="st">&#39;* leaf&#39;</span>))</span>
<span id="cb58-3"><a href="heterogeneous-treatment-effect-1.html#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (num.leaves <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb58-4"><a href="heterogeneous-treatment-effect-1.html#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;Skipping since there&#39;s a single leaf.&quot;</span>)</span>
<span id="cb58-5"><a href="heterogeneous-treatment-effect-1.html#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="heterogeneous-treatment-effect-1.html#cb58-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (num.leaves <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb58-7"><a href="heterogeneous-treatment-effect-1.html#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if there are only two leaves, no need to correct for multiple hypotheses</span></span>
<span id="cb58-8"><a href="heterogeneous-treatment-effect-1.html#cb58-8" aria-hidden="true" tabindex="-1"></a>  ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data[indices<span class="sc">$</span>est,], <span class="at">leaf=</span>leaf))</span>
<span id="cb58-9"><a href="heterogeneous-treatment-effect-1.html#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="st">&#39;HC2&#39;</span>))[<span class="dv">4</span>,,drop<span class="ot">=</span>F]</span>
<span id="cb58-10"><a href="heterogeneous-treatment-effect-1.html#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="heterogeneous-treatment-effect-1.html#cb58-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb58-12"><a href="heterogeneous-treatment-effect-1.html#cb58-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if there are three or more leaves, use Romano-Wolf test correction </span></span>
<span id="cb58-13"><a href="heterogeneous-treatment-effect-1.html#cb58-13" aria-hidden="true" tabindex="-1"></a>  ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data[indices<span class="sc">$</span>est,], <span class="at">leaf=</span>leaf))</span>
<span id="cb58-14"><a href="heterogeneous-treatment-effect-1.html#cb58-14" aria-hidden="true" tabindex="-1"></a>  interact <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols)), <span class="cf">function</span>(x) <span class="fu">grepl</span>(<span class="fu">paste0</span>(treatment, <span class="st">&quot;:&quot;</span>), x)))</span>
<span id="cb58-15"><a href="heterogeneous-treatment-effect-1.html#cb58-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span>interact, <span class="at">cov.type =</span> <span class="st">&#39;HC2&#39;</span>)</span>
<span id="cb58-16"><a href="heterogeneous-treatment-effect-1.html#cb58-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>##           Estimate Std. Error Orig. p-value Adj. p-value
## w:leaf2 0.04261544 0.02675955  1.112984e-01       0.1137
## w:leaf3 0.08304080 0.03903846  3.343291e-02       0.0629
## w:leaf4 0.08649780 0.02999722  3.941285e-03       0.0113
## w:leaf5 0.10688672 0.03346314  1.406931e-03       0.0047
## w:leaf6 0.14399896 0.03708540  1.039142e-04       0.0005
## w:leaf7 0.17514244 0.03797784  4.045881e-06       0.0000
## w:leaf8 0.21914803 0.04269808  2.915505e-07       0.0000
## w:leaf9 0.23088896 0.06627687  4.967474e-04       0.0024</code></pre>
<p>In the chapter <code>Introduction to Machine Learning</code>, we cautioned against
interpreting the decision tree splits, and the same is true for causal
tree splits. That a tree splits on a particular variable does not mean
that this variable is relevant in the underlying data-generating process
– it could simply be correlated with some other variable that is. For
the same reason, we should not try to interpret <em>partial effects</em> from
tree output.</p>
<p>However, similar to what we have done in previous chapters, we can try
to understand how the joint distribution of covariates varies for
subgroups with different estimated treatment effects. The annotated
heatmap below shows the average value of each covariate within each
leaf. Leaves are ordered from lowest to highest treatment effect
estimate. The color is a normalized distance of each leaf-specific
covariate mean from the overall covariate mean, i.e..,
<span class="math inline">\(\smash{\Phi^{-1}\left((\widehat{\text{E}}[X_i|L_i] - \widehat{\text{E}}[X_i])/\widehat{\text{Var}}(\widehat{\text{E}}[X_i|L_i])\right)}\)</span>.
The rows are in descending order of variation, measured by
<span class="math inline">\(\widehat{\text{Var}}(\widehat{\text{E}}[X_i|L_i])/\widehat{\text{Var}}(X_i)\)</span>.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="heterogeneous-treatment-effect-1.html#cb60-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">mapply</span>(<span class="cf">function</span>(covariate) {</span>
<span id="cb60-2"><a href="heterogeneous-treatment-effect-1.html#cb60-2" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Looping over covariate names</span></span>
<span id="cb60-3"><a href="heterogeneous-treatment-effect-1.html#cb60-3" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute average covariate value per leaf (with correct standard errors)</span></span>
<span id="cb60-4"><a href="heterogeneous-treatment-effect-1.html#cb60-4" aria-hidden="true" tabindex="-1"></a>      fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(covariate, <span class="st">&quot;~ 0 + leaf&quot;</span>))</span>
<span id="cb60-5"><a href="heterogeneous-treatment-effect-1.html#cb60-5" aria-hidden="true" tabindex="-1"></a>      ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data[indices<span class="sc">$</span>est,], <span class="at">leaf=</span>leaf))</span>
<span id="cb60-6"><a href="heterogeneous-treatment-effect-1.html#cb60-6" aria-hidden="true" tabindex="-1"></a>      ols.res <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="st">&quot;HC2&quot;</span>))</span>
<span id="cb60-7"><a href="heterogeneous-treatment-effect-1.html#cb60-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-8"><a href="heterogeneous-treatment-effect-1.html#cb60-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Retrieve results</span></span>
<span id="cb60-9"><a href="heterogeneous-treatment-effect-1.html#cb60-9" aria-hidden="true" tabindex="-1"></a>      avg <span class="ot">&lt;-</span> ols.res[,<span class="dv">1</span>]</span>
<span id="cb60-10"><a href="heterogeneous-treatment-effect-1.html#cb60-10" aria-hidden="true" tabindex="-1"></a>      stderr <span class="ot">&lt;-</span> ols.res[,<span class="dv">2</span>]</span>
<span id="cb60-11"><a href="heterogeneous-treatment-effect-1.html#cb60-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb60-12"><a href="heterogeneous-treatment-effect-1.html#cb60-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Tally up results</span></span>
<span id="cb60-13"><a href="heterogeneous-treatment-effect-1.html#cb60-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(covariate, avg, stderr, <span class="at">leaf=</span><span class="fu">paste0</span>(<span class="st">&quot;Leaf&quot;</span>, <span class="fu">seq</span>(num.leaves)), </span>
<span id="cb60-14"><a href="heterogeneous-treatment-effect-1.html#cb60-14" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># Used for coloring</span></span>
<span id="cb60-15"><a href="heterogeneous-treatment-effect-1.html#cb60-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">scaling=</span><span class="fu">pnorm</span>((avg <span class="sc">-</span> <span class="fu">mean</span>(avg))<span class="sc">/</span><span class="fu">sd</span>(avg)), </span>
<span id="cb60-16"><a href="heterogeneous-treatment-effect-1.html#cb60-16" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># We will order based on how much variation is &#39;explain&#39; by the averages</span></span>
<span id="cb60-17"><a href="heterogeneous-treatment-effect-1.html#cb60-17" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># relative to the total variation of the covariate in the data</span></span>
<span id="cb60-18"><a href="heterogeneous-treatment-effect-1.html#cb60-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">variation=</span><span class="fu">sd</span>(avg) <span class="sc">/</span> <span class="fu">sd</span>(data[,covariate]),</span>
<span id="cb60-19"><a href="heterogeneous-treatment-effect-1.html#cb60-19" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># String to print in each cell in heatmap below</span></span>
<span id="cb60-20"><a href="heterogeneous-treatment-effect-1.html#cb60-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">labels=</span><span class="fu">paste0</span>(<span class="fu">signif</span>(avg, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;(&quot;</span>, <span class="fu">signif</span>(stderr, <span class="dv">3</span>), <span class="st">&quot;)&quot;</span>))</span>
<span id="cb60-21"><a href="heterogeneous-treatment-effect-1.html#cb60-21" aria-hidden="true" tabindex="-1"></a>}, covariates, <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb60-22"><a href="heterogeneous-treatment-effect-1.html#cb60-22" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, df)</span>
<span id="cb60-23"><a href="heterogeneous-treatment-effect-1.html#cb60-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-24"><a href="heterogeneous-treatment-effect-1.html#cb60-24" aria-hidden="true" tabindex="-1"></a><span class="co"># a small optional trick to ensure heatmap will be in decreasing order of &#39;variation&#39;</span></span>
<span id="cb60-25"><a href="heterogeneous-treatment-effect-1.html#cb60-25" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>covariate <span class="ot">&lt;-</span> <span class="fu">reorder</span>(df<span class="sc">$</span>covariate, <span class="fu">order</span>(df<span class="sc">$</span>variation))</span>
<span id="cb60-26"><a href="heterogeneous-treatment-effect-1.html#cb60-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-27"><a href="heterogeneous-treatment-effect-1.html#cb60-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot heatmap</span></span>
<span id="cb60-28"><a href="heterogeneous-treatment-effect-1.html#cb60-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb60-29"><a href="heterogeneous-treatment-effect-1.html#cb60-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(leaf, covariate) <span class="sc">+</span></span>
<span id="cb60-30"><a href="heterogeneous-treatment-effect-1.html#cb60-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> scaling)) <span class="sc">+</span> </span>
<span id="cb60-31"><a href="heterogeneous-treatment-effect-1.html#cb60-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> labels)) <span class="sc">+</span></span>
<span id="cb60-32"><a href="heterogeneous-treatment-effect-1.html#cb60-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">&quot;#E1BE6A&quot;</span>, <span class="at">high =</span> <span class="st">&quot;#40B0A6&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-33"><a href="heterogeneous-treatment-effect-1.html#cb60-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&quot;Average covariate values within each leaf&quot;</span>)) <span class="sc">+</span></span>
<span id="cb60-34"><a href="heterogeneous-treatment-effect-1.html#cb60-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb60-35"><a href="heterogeneous-treatment-effect-1.html#cb60-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-36"><a href="heterogeneous-treatment-effect-1.html#cb60-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb60-37"><a href="heterogeneous-treatment-effect-1.html#cb60-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>))</span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-31-1.png" width="672" /></p>
<p><font size=1> Interpret the heatmap above. What describes the subgroups
with strongest and weakest estimated treatment effect? </font></p>
</div>
<div id="via-grf" class="section level3" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Via grf</h3>
<p>The function <code>causal_forest</code> from the package <code>grf</code> allows us to get
estimates of the CATE <a href="heterogeneous-treatment-effect-1.html#eq:cate">(6.1)</a>.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="heterogeneous-treatment-effect-1.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions from forest fitted above.</span></span>
<span id="cb61-2"><a href="heterogeneous-treatment-effect-1.html#cb61-2" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest.tau)<span class="sc">$</span>predictions  <span class="co"># tau(X) estimates</span></span></code></pre></div>
<p>CFなどのノンパラ手法を使ったとき、その処置効果の予測値の分布を見たくなるかもしれない。もしヒストグラムが一点に集中していたら異質性がなさそうで、ヒストグラムが広がっていたら異質性がありそうだと考えるかもしれない。しかし、その考え方は間違っている。</p>
<blockquote>
<p>Having fit a non-parametric method such as a causal forest, a
researcher may (incorrectly) start by looking at the distribution of
its predictions of the treatment effect. One might be tempted to
think: “if the histogram is concentrated at a point, then there is no
heterogeneity; if the histogram is spread out, then our estimator has
found interesting heterogeneity.” However, this may be false.</p>
</blockquote>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="heterogeneous-treatment-effect-1.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Do not use this for assessing heterogeneity. See text above.</span></span>
<span id="cb62-2"><a href="heterogeneous-treatment-effect-1.html#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(tau.hat, <span class="at">main=</span><span class="st">&quot;CATE estimates&quot;</span>, <span class="at">freq=</span>F)</span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p>もしヒストグラムが一点に集中していれば、単純に検出力不足かもしれない。すなわち異質性を検出できなかったが、もっとデータが多ければ検出できるかもしれない。ヒストグラムが広がっているのは、オーバーフィットしている可能性がある。ノイズを含んで条件付き処置効果を推定してしまっているかもしれず、実際には条件付き処置効果はもっとxに対してなめらかな形かもしれない。</p>
<blockquote>
<p>If the histogram is concentrated at a point, we may simply be
underpowered: our method was not able to detect any heterogeneity, but
maybe it would detect it if we had more data. If the histogram is
spread out, we may be overfitting: our model is producing very noisy
estimates <span class="math inline">\(\widehat{\tau}(x)\)</span>, but in fact the true <span class="math inline">\(\tau(x)\)</span> can be
much smoother as a function of <span class="math inline">\(x\)</span>.</p>
</blockquote>
<p>grfパッケージは変数重要度を出力することができる。変数重要度とは、その変数がどれくらい多く木の分割基準として使われたかを表す。ヒストグラムの例と同様に、これも荒い診断にはなるが、重要度が低い変数は異質性をもたらしていないといった簡単に結論付けをすることはできない。これには、causal
treeの節で見てきたことと同様の説明が可能である。もし2つの変数が高い相関を持っていれば、例え2変数ともDGP的には意味を持っていたとしても（もしくは2変数とも関係なかったとしても）片方の変数だけを用いて木の分割は行われてもおかしくない。</p>
<blockquote>
<p>The <code>grf</code> package also produces a measure of variable importance that
indicates how often a variable was used in a tree split. Again, much
like the histogram above, this can be a rough diagnostic, but it
should not be interpreted as indicating that, for example, variable
with low importance is not related to heterogeneity. The reasoning is
the same as the one presented in the causal trees section: if two
covariates are highly correlated, the trees might split on one
covariate but not the other, even though both (or maybe neither) are
relevant in the true data-generating process.</p>
</blockquote>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="heterogeneous-treatment-effect-1.html#cb63-1" aria-hidden="true" tabindex="-1"></a>var_imp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">variable_importance</span>(forest.tau))</span>
<span id="cb63-2"><a href="heterogeneous-treatment-effect-1.html#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(var_imp) <span class="ot">&lt;-</span> covariates</span>
<span id="cb63-3"><a href="heterogeneous-treatment-effect-1.html#cb63-3" aria-hidden="true" tabindex="-1"></a>sorted_var_imp <span class="ot">&lt;-</span> <span class="fu">sort</span>(var_imp, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-4"><a href="heterogeneous-treatment-effect-1.html#cb63-4" aria-hidden="true" tabindex="-1"></a>sorted_var_imp[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]  <span class="co"># showing only first few</span></span></code></pre></div>
<pre><code>##   polviews     income        age       educ    marital 
## 0.42566545 0.35099325 0.09706847 0.07540505 0.04353924</code></pre>
<div id="data-driven-subgroups" class="section level4" number="6.2.2.1">
<h4><span class="header-section-number">6.2.2.1</span> Data-driven subgroups</h4>
<p>Causal treeと同様に、Causal
forestを使ってサブグループにサンプルを分けることができる。葉の代わりに、推定されたCATEをもとに、サンプルを順位付けをして、例えば５分割にすることができる。</p>
<p>（メモ：CATE自体は、すべてのサンプルに計算されるため、それをランク付けすることはできる。ただし、それだとあるobsをCATEのモデル推定と、CATEの推定の両方に使ってしまうこととなり良くない。なので、fold1~4でモデル推定、fold5で推定。</p>
<p>難しいが検討すべき重要な点がある。すでに述べたように、サンプルiに対してCATEを推定するときには、サンプルiを用いてフィットされたモデルを一般に使うべきではない。このようなサンプル分割（上でhonestyと呼んだもの）は、CATEをバイアスなく推定するための一つの材料となる。しかし、もし二つの観測iとjについて順位付けをしようと思うと、より強い仮定として、モデルはiもjも使わずに推定されている必要がある。</p>
<blockquote>
<p>Just as with causal trees, we can use causal forests to divide our
observations into subgroups. In place of leaves, we’ll rank
observation into (say) quintiles according to their estimated CATE
prediction; see, e.g., <a href="https://arxiv.org/abs/1712.04802">Chernozhukov, Demirer, Duflo, Fernández-Val
(2020)</a> for similar ideas.</p>
<p>There’s a subtle but important point that needs to be addressed here.
As we have mentioned before, when predicting the conditional average
treatment effect <span class="math inline">\(\widehat{\tau}(X_i)\)</span> for observation <span class="math inline">\(i\)</span> we should
in general avoid using a model that was fitted using observation <span class="math inline">\(i\)</span>.
This sort of sample splitting (which we called <strong>honesty</strong> above) is
one of the required ingredients to get unbiased estimates of the CATE
using the methods described here. However, when ranking estimates of
two observations <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>, we need something a little stronger: we
must ensure that the model was not fit using <em>either</em> <span class="math inline">\(i\)</span> <em>or</em> <span class="math inline">\(j\)</span>’s
data.</p>
</blockquote>
<p>これを克服する方法は単純である。まずデータをK個のサンプル群に分ける。次に、群ごとに順番に、CATEモデルをK-1個の群にフィットさせる。その上で、残しておいた１つの群に対して、「別々に」まだ見ていないサンプルをQ個のグループに順位付けをする。（Q=5の場合、CATEに基づき1分位グループ、2分位グループなどと分ける）それらのランク付けを統合して、それぞれの観測値のCATEの違いを分析することができる。</p>
<p>このgistはこれをgrfで計算する。forestではなく他のノンパラメソッドに変えて同じことを行うのは難しくない。ただし、grfは特に、有効なランク付けを行うためのちょっとした仕掛けがある。それは、フォールドのインデックスのベクトルをcausal_forest関数のclustersオプションに渡すことができ、それｗぞれのfoldの中での観測値のランク漬けをできることである。それぞれのfoldの木々における推定値は、そのfold以外のサンプルを使って構築された木で推定されているため、うまくいく。</p>
<blockquote>
<p>One way of overcoming this obstacle is simple. First, divide the data
into <span class="math inline">\(K\)</span> folds (subsets). Then, cycle through the folds, fitting a
CATE model on <span class="math inline">\(K-1\)</span> folds. Next, for each held-out fold, <em>separately</em>
rank the unseen observations into <span class="math inline">\(Q\)</span> groups based on their prediction
(i.e., if <span class="math inline">\(Q=5\)</span>, then we rank observations by estimated CATE into “top
quintile”, “second quintile”, and so on). After concatenating the
independent rankings together, we can study the differences in
observations in each rank-group.</p>
<p><a href="https://gist.github.com/halflearned/bea4e5137c0c81fd18a75f682da466c8">This
gist</a>
computes the above for <code>grf</code>, and it should not be hard to modify it
so as to replace forests by any other non-parametric method. However,
for <code>grf</code> specifically, there’s a small trick that allows us to obtain
a valid ranking: we can pass a vector of fold indices to the argument
<code>clusters</code> and rank observations within each fold. This works because
estimates for each fold (“cluster”) trees are computed using trees
that were not fit using observations from that fold. Here’s how to do
it.</p>
</blockquote>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="heterogeneous-treatment-effect-1.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid randomized data and observational data with unconfoundedness+overlap.</span></span>
<span id="cb65-2"><a href="heterogeneous-treatment-effect-1.html#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: read the comments below carefully. </span></span>
<span id="cb65-3"><a href="heterogeneous-treatment-effect-1.html#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co"># In randomized settings, do not estimate forest.e and e.hat; use known assignment probs.</span></span>
<span id="cb65-4"><a href="heterogeneous-treatment-effect-1.html#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="heterogeneous-treatment-effect-1.html#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare dataset</span></span>
<span id="cb65-6"><a href="heterogeneous-treatment-effect-1.html#cb65-6" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~ 0 + &quot;</span>, <span class="fu">paste0</span>(covariates, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)))</span>
<span id="cb65-7"><a href="heterogeneous-treatment-effect-1.html#cb65-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla, data)</span>
<span id="cb65-8"><a href="heterogeneous-treatment-effect-1.html#cb65-8" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> data[,treatment]</span>
<span id="cb65-9"><a href="heterogeneous-treatment-effect-1.html#cb65-9" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> data[,outcome]</span>
<span id="cb65-10"><a href="heterogeneous-treatment-effect-1.html#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="heterogeneous-treatment-effect-1.html#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of rankings that the predictions will be ranking on </span></span>
<span id="cb65-12"><a href="heterogeneous-treatment-effect-1.html#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="co"># (e.g., 2 for above/below median estimated CATE, 5 for estimated CATE quintiles, etc.)</span></span>
<span id="cb65-13"><a href="heterogeneous-treatment-effect-1.html#cb65-13" aria-hidden="true" tabindex="-1"></a>num.rankings <span class="ot">&lt;-</span> <span class="dv">5</span>  </span>
<span id="cb65-14"><a href="heterogeneous-treatment-effect-1.html#cb65-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-15"><a href="heterogeneous-treatment-effect-1.html#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare for data.splitting</span></span>
<span id="cb65-16"><a href="heterogeneous-treatment-effect-1.html#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign a fold number to each observation.</span></span>
<span id="cb65-17"><a href="heterogeneous-treatment-effect-1.html#cb65-17" aria-hidden="true" tabindex="-1"></a><span class="co"># The argument &#39;clusters&#39; in the next step will mimick K-fold cross-fitting.</span></span>
<span id="cb65-18"><a href="heterogeneous-treatment-effect-1.html#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="co"># clustersにグループのインデックスを渡すことで、K-fold cross-fittingをまねることができる。</span></span>
<span id="cb65-19"><a href="heterogeneous-treatment-effect-1.html#cb65-19" aria-hidden="true" tabindex="-1"></a><span class="co"># サンプルサイズ分のしーくんすを作って、それをfold数で割った余りを取ることで、グループ番号を振る。</span></span>
<span id="cb65-20"><a href="heterogeneous-treatment-effect-1.html#cb65-20" aria-hidden="true" tabindex="-1"></a><span class="co"># foldsは c(1,1,1,...2,2,2....,3,3,3,...,)というベクトルになっている。</span></span>
<span id="cb65-21"><a href="heterogeneous-treatment-effect-1.html#cb65-21" aria-hidden="true" tabindex="-1"></a>num.folds <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb65-22"><a href="heterogeneous-treatment-effect-1.html#cb65-22" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">seq</span>(n) <span class="sc">%%</span> num.folds) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb65-23"><a href="heterogeneous-treatment-effect-1.html#cb65-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-24"><a href="heterogeneous-treatment-effect-1.html#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Comment or uncomment depending on your setting.</span></span>
<span id="cb65-25"><a href="heterogeneous-treatment-effect-1.html#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Observational setting with unconfoundedness+overlap (unknown assignment probs):</span></span>
<span id="cb65-26"><a href="heterogeneous-treatment-effect-1.html#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="co"># forest &lt;- causal_forest(X, Y, W, clusters = folds)</span></span>
<span id="cb65-27"><a href="heterogeneous-treatment-effect-1.html#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Randomized settings with fixed and known probabilities (here: 0.5).</span></span>
<span id="cb65-28"><a href="heterogeneous-treatment-effect-1.html#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 上で用意したfoldsをclustersに渡す。</span></span>
<span id="cb65-29"><a href="heterogeneous-treatment-effect-1.html#cb65-29" aria-hidden="true" tabindex="-1"></a>forest <span class="ot">&lt;-</span> <span class="fu">causal_forest</span>(X, Y, W, <span class="at">W.hat=</span>.<span class="dv">5</span>, <span class="at">clusters =</span> folds)</span>
<span id="cb65-30"><a href="heterogeneous-treatment-effect-1.html#cb65-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-31"><a href="heterogeneous-treatment-effect-1.html#cb65-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve out-of-bag predictions.</span></span>
<span id="cb65-32"><a href="heterogeneous-treatment-effect-1.html#cb65-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions for observation in fold k will be computed using </span></span>
<span id="cb65-33"><a href="heterogeneous-treatment-effect-1.html#cb65-33" aria-hidden="true" tabindex="-1"></a><span class="co"># trees that were not trained using observations for that fold.</span></span>
<span id="cb65-34"><a href="heterogeneous-treatment-effect-1.html#cb65-34" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest)<span class="sc">$</span>predictions</span>
<span id="cb65-35"><a href="heterogeneous-treatment-effect-1.html#cb65-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-36"><a href="heterogeneous-treatment-effect-1.html#cb65-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ランク付けをする。fold順に、当該foldにおけるtau.hatを持ってきて、quantile関数で順位付けする。</span></span>
<span id="cb65-37"><a href="heterogeneous-treatment-effect-1.html#cb65-37" aria-hidden="true" tabindex="-1"></a><span class="co"># tau.hat.quantilesは5分位の切れ目を出している。</span></span>
<span id="cb65-38"><a href="heterogeneous-treatment-effect-1.html#cb65-38" aria-hidden="true" tabindex="-1"></a><span class="co"># これを切れ目として、cut関数で切る</span></span>
<span id="cb65-39"><a href="heterogeneous-treatment-effect-1.html#cb65-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 1つ目のfoldは、このfoldで推定されたtau.hatを5分位で切る。この5分位点をもとに、このfoldについては順位付けをするということ。</span></span>
<span id="cb65-40"><a href="heterogeneous-treatment-effect-1.html#cb65-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-41"><a href="heterogeneous-treatment-effect-1.html#cb65-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Rank observations *within each fold* into quintiles according to their CATE predictions.</span></span>
<span id="cb65-42"><a href="heterogeneous-treatment-effect-1.html#cb65-42" aria-hidden="true" tabindex="-1"></a>ranking <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n)</span>
<span id="cb65-43"><a href="heterogeneous-treatment-effect-1.html#cb65-43" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (fold <span class="cf">in</span> <span class="fu">seq</span>(num.folds)) {</span>
<span id="cb65-44"><a href="heterogeneous-treatment-effect-1.html#cb65-44" aria-hidden="true" tabindex="-1"></a>  tau.hat.quantiles <span class="ot">&lt;-</span> <span class="fu">quantile</span>(tau.hat[folds <span class="sc">==</span> fold], </span>
<span id="cb65-45"><a href="heterogeneous-treatment-effect-1.html#cb65-45" aria-hidden="true" tabindex="-1"></a>                                <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by=</span><span class="dv">1</span><span class="sc">/</span>num.rankings))</span>
<span id="cb65-46"><a href="heterogeneous-treatment-effect-1.html#cb65-46" aria-hidden="true" tabindex="-1"></a>  ranking[folds <span class="sc">==</span> fold] <span class="ot">&lt;-</span> <span class="fu">cut</span>(tau.hat[folds <span class="sc">==</span> fold], </span>
<span id="cb65-47"><a href="heterogeneous-treatment-effect-1.html#cb65-47" aria-hidden="true" tabindex="-1"></a>                                tau.hat.quantiles,</span>
<span id="cb65-48"><a href="heterogeneous-treatment-effect-1.html#cb65-48" aria-hidden="true" tabindex="-1"></a>                                <span class="at">include.lowest=</span><span class="cn">TRUE</span>,</span>
<span id="cb65-49"><a href="heterogeneous-treatment-effect-1.html#cb65-49" aria-hidden="true" tabindex="-1"></a>                                <span class="at">labels=</span><span class="fu">seq</span>(num.rankings))</span>
<span id="cb65-50"><a href="heterogeneous-treatment-effect-1.html#cb65-50" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>以下はメモ。tau.hatが各ランキングでオーバーラップする。</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="heterogeneous-treatment-effect-1.html#cb66-1" aria-hidden="true" tabindex="-1"></a>tt<span class="ot">&lt;-</span><span class="fu">tibble</span>(ranking,tau.hat)</span>
<span id="cb66-2"><a href="heterogeneous-treatment-effect-1.html#cb66-2" aria-hidden="true" tabindex="-1"></a>tt <span class="sc">%&gt;%</span></span>
<span id="cb66-3"><a href="heterogeneous-treatment-effect-1.html#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ranking) <span class="sc">%&gt;%</span></span>
<span id="cb66-4"><a href="heterogeneous-treatment-effect-1.html#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">min</span>(tau.hat),<span class="fu">max</span>(tau.hat))</span></code></pre></div>
<pre><code>## # A tibble: 5 x 3
##   ranking `min(tau.hat)` `max(tau.hat)`
##     &lt;int&gt;          &lt;dbl&gt;          &lt;dbl&gt;
## 1       1         -0.629       -0.424  
## 2       2         -0.444       -0.372  
## 3       3         -0.392       -0.321  
## 4       4         -0.345       -0.251  
## 5       5         -0.278        0.00488</code></pre>
<p>以下のコードは、上で定義されたグループごとのATEを計算する。これは2つの方法でできる。まず、単純にそれぞれのグループにおけるATEの差をみる方法である。これはランダム化されている場合のみ有効な方法である。</p>
<p>The next snippet computes the average treatment effect within each group
defined above, i.e., <span class="math inline">\(\mathop{\mathrm{E}}[Y_i(1) - Y_i(0)|G_i = g]\)</span>.
This can done in two ways. First, by computing a simple
difference-in-means estimate of the ATE based on observations within
each group. This is valid only in randomized settings.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="heterogeneous-treatment-effect-1.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid only in randomized settings.</span></span>
<span id="cb68-2"><a href="heterogeneous-treatment-effect-1.html#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Average difference-in-means within each ranking</span></span>
<span id="cb68-3"><a href="heterogeneous-treatment-effect-1.html#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="heterogeneous-treatment-effect-1.html#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co"># グループダミーと処置とグループの交差項を入れてOLSするだけ</span></span>
<span id="cb68-5"><a href="heterogeneous-treatment-effect-1.html#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Formula y ~ 0 + ranking + ranking:w</span></span>
<span id="cb68-6"><a href="heterogeneous-treatment-effect-1.html#cb68-6" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">paste0</span>(outcome, <span class="st">&quot; ~ 0 + ranking + ranking:&quot;</span>, treatment)</span>
<span id="cb68-7"><a href="heterogeneous-treatment-effect-1.html#cb68-7" aria-hidden="true" tabindex="-1"></a>ols.ate <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data, <span class="at">ranking=</span><span class="fu">factor</span>(ranking)))</span>
<span id="cb68-8"><a href="heterogeneous-treatment-effect-1.html#cb68-8" aria-hidden="true" tabindex="-1"></a>ols.ate <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols.ate, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols.ate, <span class="at">type=</span><span class="st">&#39;HC2&#39;</span>))</span>
<span id="cb68-9"><a href="heterogeneous-treatment-effect-1.html#cb68-9" aria-hidden="true" tabindex="-1"></a>interact <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">&quot;:&quot;</span>, <span class="fu">rownames</span>(ols.ate)))</span>
<span id="cb68-10"><a href="heterogeneous-treatment-effect-1.html#cb68-10" aria-hidden="true" tabindex="-1"></a>ols.ate <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;ols&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;Q&quot;</span>, <span class="fu">seq</span>(num.rankings)), ols.ate[interact, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb68-11"><a href="heterogeneous-treatment-effect-1.html#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ols.ate) <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># just for display</span></span>
<span id="cb68-12"><a href="heterogeneous-treatment-effect-1.html#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(ols.ate) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;method&quot;</span>, <span class="st">&quot;ranking&quot;</span>, <span class="st">&quot;estimate&quot;</span>, <span class="st">&quot;std.err&quot;</span>)</span>
<span id="cb68-13"><a href="heterogeneous-treatment-effect-1.html#cb68-13" aria-hidden="true" tabindex="-1"></a>ols.ate</span></code></pre></div>
<pre><code>##   method ranking   estimate     std.err
## 1    ols      Q1 -0.4426981 0.011318499
## 2    ols      Q2 -0.3913922 0.011220876
## 3    ols      Q3 -0.3615371 0.011012274
## 4    ols      Q4 -0.3280377 0.010481311
## 5    ols      Q5 -0.2145588 0.009766637</code></pre>
<p>もう一つの方法としては、AIPWをそれぞれのグループで平均をとる方法である。この方法はランダム化されたサンプルでも、観察データでも（UnconfoundednessとOverlap条件が満たされていてれば）利用可能である。さらに、AIPWベースの推定は大サンプルにおいてより狭い信頼区間を構築することができる。</p>
<p>Another option is to average the AIPW scores within each group. This
valid for both randomized settings and observational settings with
unconfoundedness and overlap. Moreover, AIPW-based estimators should
produce estimates with tighter confidence intervals in large samples.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="heterogeneous-treatment-effect-1.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Computing AIPW scores.</span></span>
<span id="cb70-2"><a href="heterogeneous-treatment-effect-1.html#cb70-2" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest)<span class="sc">$</span>predictions</span>
<span id="cb70-3"><a href="heterogeneous-treatment-effect-1.html#cb70-3" aria-hidden="true" tabindex="-1"></a>e.hat <span class="ot">&lt;-</span> forest<span class="sc">$</span>W.hat <span class="co"># P[W=1|X]</span></span>
<span id="cb70-4"><a href="heterogeneous-treatment-effect-1.html#cb70-4" aria-hidden="true" tabindex="-1"></a>m.hat <span class="ot">&lt;-</span> forest<span class="sc">$</span>Y.hat <span class="co"># E[Y|X]</span></span>
<span id="cb70-5"><a href="heterogeneous-treatment-effect-1.html#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="heterogeneous-treatment-effect-1.html#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimating mu.hat(X, 1) and mu.hat(X, 0) for obs in held-out sample</span></span>
<span id="cb70-7"><a href="heterogeneous-treatment-effect-1.html#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: to understand this, read equations 6-8 in this vignette:</span></span>
<span id="cb70-8"><a href="heterogeneous-treatment-effect-1.html#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co"># https://grf-labs.github.io/grf/articles/muhats.html</span></span>
<span id="cb70-9"><a href="heterogeneous-treatment-effect-1.html#cb70-9" aria-hidden="true" tabindex="-1"></a>mu.hat<span class="fl">.0</span> <span class="ot">&lt;-</span> m.hat <span class="sc">-</span> e.hat <span class="sc">*</span> tau.hat        <span class="co"># E[Y|X,W=0] = E[Y|X] - e(X)*tau(X)</span></span>
<span id="cb70-10"><a href="heterogeneous-treatment-effect-1.html#cb70-10" aria-hidden="true" tabindex="-1"></a>mu.hat<span class="fl">.1</span> <span class="ot">&lt;-</span> m.hat <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> e.hat) <span class="sc">*</span> tau.hat  <span class="co"># E[Y|X,W=1] = E[Y|X] + (1 - e(X))*tau(X)</span></span>
<span id="cb70-11"><a href="heterogeneous-treatment-effect-1.html#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="heterogeneous-treatment-effect-1.html#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="co"># AIPW scores</span></span>
<span id="cb70-13"><a href="heterogeneous-treatment-effect-1.html#cb70-13" aria-hidden="true" tabindex="-1"></a>aipw.scores <span class="ot">&lt;-</span> tau.hat <span class="sc">+</span> W <span class="sc">/</span> e.hat <span class="sc">*</span> (Y <span class="sc">-</span>  mu.hat<span class="fl">.1</span>) <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> W) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> e.hat) <span class="sc">*</span> (Y <span class="sc">-</span>  mu.hat<span class="fl">.0</span>)</span>
<span id="cb70-14"><a href="heterogeneous-treatment-effect-1.html#cb70-14" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(aipw.scores <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">factor</span>(ranking))</span>
<span id="cb70-15"><a href="heterogeneous-treatment-effect-1.html#cb70-15" aria-hidden="true" tabindex="-1"></a>forest.ate <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;aipw&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;Q&quot;</span>, <span class="fu">seq</span>(num.rankings)), <span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="st">&quot;HC2&quot;</span>))[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb70-16"><a href="heterogeneous-treatment-effect-1.html#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(forest.ate) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;method&quot;</span>, <span class="st">&quot;ranking&quot;</span>, <span class="st">&quot;estimate&quot;</span>, <span class="st">&quot;std.err&quot;</span>)</span>
<span id="cb70-17"><a href="heterogeneous-treatment-effect-1.html#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(forest.ate) <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># just for display</span></span>
<span id="cb70-18"><a href="heterogeneous-treatment-effect-1.html#cb70-18" aria-hidden="true" tabindex="-1"></a>forest.ate</span></code></pre></div>
<pre><code>##   method ranking   estimate     std.err
## 1   aipw      Q1 -0.4424803 0.011049087
## 2   aipw      Q2 -0.3929507 0.010791788
## 3   aipw      Q3 -0.3602181 0.010615964
## 4   aipw      Q4 -0.3297784 0.010208337
## 5   aipw      Q5 -0.2104361 0.009309925</code></pre>
<p>The code below plots the estimates.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="heterogeneous-treatment-effect-1.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate the two results.</span></span>
<span id="cb72-2"><a href="heterogeneous-treatment-effect-1.html#cb72-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(forest.ate, ols.ate)</span>
<span id="cb72-3"><a href="heterogeneous-treatment-effect-1.html#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="heterogeneous-treatment-effect-1.html#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the point estimate of average treatment effect </span></span>
<span id="cb72-5"><a href="heterogeneous-treatment-effect-1.html#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="co"># and 95% confidence intervals around it.</span></span>
<span id="cb72-6"><a href="heterogeneous-treatment-effect-1.html#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res) <span class="sc">+</span></span>
<span id="cb72-7"><a href="heterogeneous-treatment-effect-1.html#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> ranking, <span class="at">y =</span> estimate, <span class="at">group=</span>method, <span class="at">color=</span>method) <span class="sc">+</span> </span>
<span id="cb72-8"><a href="heterogeneous-treatment-effect-1.html#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb72-9"><a href="heterogeneous-treatment-effect-1.html#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>estimate<span class="dv">-2</span><span class="sc">*</span>std.err, <span class="at">ymax=</span>estimate<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>std.err), <span class="at">width=</span>.<span class="dv">2</span>, <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb72-10"><a href="heterogeneous-treatment-effect-1.html#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb72-11"><a href="heterogeneous-treatment-effect-1.html#cb72-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Average CATE within each ranking (as defined by predicted CATE)&quot;</span>) <span class="sc">+</span></span>
<span id="cb72-12"><a href="heterogeneous-treatment-effect-1.html#cb72-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb72-13"><a href="heterogeneous-treatment-effect-1.html#cb72-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;bottom&quot;</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
<p>もし検出可能なだけの異質性がない場合には、上のプロットは、単調でなくなることもある。これはサンプル数が少なすぎて、処置効果の差が見られるようなサブグループを検出できなかったことを意味する。</p>
<p>演習として、上の2つのコードを少ないサンプル数で試してみよ（例えば最初の1000のサンプルのみを用いるなど）。おそらく非単調となるケースが確認できるだろう。</p>
<blockquote>
<p>When there isn’t much detectable heterogeneity, the plot above can end
up being non-monotonic. This can mean that the number of observations
is too small for us to be able to detect subgroups with relevant
differences in treatment effect.</p>
<p><font size=1> As an exercise, try running the previous two snippets on
few data points (e.g., the first thousand observations only). You will
likely see the “non-monotonicity” phenomenon just described. </font></p>
</blockquote>
<p>次に、causal
treeでやったように、グループ２やグループ３の推定値がグループ１に比べて大きいのかといった検定を行うことができる。平均値の差の推定値に基づく検定方法をいかに示す。Romano-Wolfの複数仮説検定の補正に注意せよ。</p>
<blockquote>
<p>Next, as we did for leaves in a causal tree, we can test e.g., if the
prediction for groups 2, 3, etc. are larger than the one in the first
group. Here’s how to do it based on a difference-in-means estimator.
Note the Romano-Wolf multiple-hypothesis testing correction.</p>
</blockquote>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="heterogeneous-treatment-effect-1.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid in randomized settings only.</span></span>
<span id="cb73-2"><a href="heterogeneous-treatment-effect-1.html#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="heterogeneous-treatment-effect-1.html#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co"># y ~ ranking + w + ranking:w</span></span>
<span id="cb73-4"><a href="heterogeneous-treatment-effect-1.html#cb73-4" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">paste0</span>(outcome, <span class="st">&quot;~ ranking + &quot;</span>, treatment, <span class="st">&quot; + ranking:&quot;</span>, treatment) </span>
<span id="cb73-5"><a href="heterogeneous-treatment-effect-1.html#cb73-5" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data, <span class="at">ranking=</span><span class="fu">factor</span>(ranking)))</span>
<span id="cb73-6"><a href="heterogeneous-treatment-effect-1.html#cb73-6" aria-hidden="true" tabindex="-1"></a>interact <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(<span class="fu">names</span>(<span class="fu">coef</span>(ols)), <span class="cf">function</span>(x) <span class="fu">grepl</span>(<span class="st">&quot;:&quot;</span>, x)))</span>
<span id="cb73-7"><a href="heterogeneous-treatment-effect-1.html#cb73-7" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span>interact)</span>
<span id="cb73-8"><a href="heterogeneous-treatment-effect-1.html#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(res) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Rank&quot;</span>, <span class="dv">2</span><span class="sc">:</span>num.rankings, <span class="st">&quot;- Rank 1&quot;</span>) <span class="co"># just for display</span></span>
<span id="cb73-9"><a href="heterogeneous-treatment-effect-1.html#cb73-9" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div>
<pre><code>##                   Estimate Std. Error Orig. p-value Adj. p-value
## Rank 2 - Rank 1 0.05130589 0.01475862  5.090710e-04        5e-04
## Rank 3 - Rank 1 0.08116094 0.01474333  3.724843e-08        0e+00
## Rank 4 - Rank 1 0.11466040 0.01473507  7.409688e-15        0e+00
## Rank 5 - Rank 1 0.22813924 0.01474804  9.254246e-54        0e+00</code></pre>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="heterogeneous-treatment-effect-1.html#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 分析手法の確認のために追加.以下と同じことをやっている。</span></span>
<span id="cb75-2"><a href="heterogeneous-treatment-effect-1.html#cb75-2" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span></span>
<span id="cb75-3"><a href="heterogeneous-treatment-effect-1.html#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(y<span class="sc">~</span>w<span class="sc">*</span><span class="fu">factor</span>(ranking),<span class="at">data=</span>.) <span class="sc">%&gt;%</span></span>
<span id="cb75-4"><a href="heterogeneous-treatment-effect-1.html#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary_rw_lm</span>(<span class="at">indices=</span>interact)</span></code></pre></div>
<pre><code>##                      Estimate Std. Error Orig. p-value Adj. p-value
## w:factor(ranking)2 0.05130589 0.01475862  5.090710e-04        6e-04
## w:factor(ranking)3 0.08116094 0.01474333  3.724843e-08        0e+00
## w:factor(ranking)4 0.11466040 0.01473507  7.409688e-15        0e+00
## w:factor(ranking)5 0.22813924 0.01474804  9.254246e-54        0e+00</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="heterogeneous-treatment-effect-1.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co">#　rwはRomano Wolfの補正のp値を出すための関数</span></span></code></pre></div>
<p>以下はAIPWベースの推定である。これもRomano Wolfの補正をしている。</p>
<p>Here’s how to do it for AIPW-based estimates, again with Romano-Wolf
correction for multiple hypothesis testing.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="heterogeneous-treatment-effect-1.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valid in randomized and observational settings with unconfoundedness+overlap.</span></span>
<span id="cb78-2"><a href="heterogeneous-treatment-effect-1.html#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="heterogeneous-treatment-effect-1.html#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Using AIPW scores computed above</span></span>
<span id="cb78-4"><a href="heterogeneous-treatment-effect-1.html#cb78-4" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(aipw.scores <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">factor</span>(ranking))</span>
<span id="cb78-5"><a href="heterogeneous-treatment-effect-1.html#cb78-5" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">summary_rw_lm</span>(ols, <span class="at">indices=</span><span class="dv">2</span><span class="sc">:</span>num.rankings)</span>
<span id="cb78-6"><a href="heterogeneous-treatment-effect-1.html#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(res) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Rank&quot;</span>, <span class="dv">2</span><span class="sc">:</span>num.rankings, <span class="st">&quot;- Rank 1&quot;</span>) <span class="co"># just for display</span></span>
<span id="cb78-7"><a href="heterogeneous-treatment-effect-1.html#cb78-7" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div>
<pre><code>##                   Estimate Std. Error Orig. p-value Adj. p-value
## Rank 2 - Rank 1 0.04952957 0.01472507  7.702729e-04        4e-04
## Rank 3 - Rank 1 0.08226219 0.01472378  2.330837e-08        0e+00
## Rank 4 - Rank 1 0.11270184 0.01472442  2.008238e-14        0e+00
## Rank 5 - Rank 1 0.23204415 0.01472507  1.030543e-55        0e+00</code></pre>
<p>最後に、グループごとの共変量の平均値を比較することもできる。</p>
<p>Finally, we can also check if different groups have different average
covariate levels across rankings.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="heterogeneous-treatment-effect-1.html#cb80-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">mapply</span>(<span class="cf">function</span>(covariate) {</span>
<span id="cb80-2"><a href="heterogeneous-treatment-effect-1.html#cb80-2" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Looping over covariate names</span></span>
<span id="cb80-3"><a href="heterogeneous-treatment-effect-1.html#cb80-3" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute average covariate value per ranking (with correct standard errors)</span></span>
<span id="cb80-4"><a href="heterogeneous-treatment-effect-1.html#cb80-4" aria-hidden="true" tabindex="-1"></a>      fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(covariate, <span class="st">&quot;~ 0 + ranking&quot;</span>))</span>
<span id="cb80-5"><a href="heterogeneous-treatment-effect-1.html#cb80-5" aria-hidden="true" tabindex="-1"></a>      ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla, <span class="at">data=</span><span class="fu">transform</span>(data, <span class="at">ranking=</span><span class="fu">factor</span>(ranking)))</span>
<span id="cb80-6"><a href="heterogeneous-treatment-effect-1.html#cb80-6" aria-hidden="true" tabindex="-1"></a>      ols.res <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(ols, <span class="at">vcov=</span><span class="fu">vcovHC</span>(ols, <span class="st">&quot;HC2&quot;</span>))</span>
<span id="cb80-7"><a href="heterogeneous-treatment-effect-1.html#cb80-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-8"><a href="heterogeneous-treatment-effect-1.html#cb80-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Retrieve results</span></span>
<span id="cb80-9"><a href="heterogeneous-treatment-effect-1.html#cb80-9" aria-hidden="true" tabindex="-1"></a>      avg <span class="ot">&lt;-</span> ols.res[,<span class="dv">1</span>]</span>
<span id="cb80-10"><a href="heterogeneous-treatment-effect-1.html#cb80-10" aria-hidden="true" tabindex="-1"></a>      stderr <span class="ot">&lt;-</span> ols.res[,<span class="dv">2</span>]</span>
<span id="cb80-11"><a href="heterogeneous-treatment-effect-1.html#cb80-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb80-12"><a href="heterogeneous-treatment-effect-1.html#cb80-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Tally up results</span></span>
<span id="cb80-13"><a href="heterogeneous-treatment-effect-1.html#cb80-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(covariate, avg, stderr, <span class="at">ranking=</span><span class="fu">paste0</span>(<span class="st">&quot;Q&quot;</span>, <span class="fu">seq</span>(num.rankings)), </span>
<span id="cb80-14"><a href="heterogeneous-treatment-effect-1.html#cb80-14" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># Used for coloring</span></span>
<span id="cb80-15"><a href="heterogeneous-treatment-effect-1.html#cb80-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">scaling=</span><span class="fu">pnorm</span>((avg <span class="sc">-</span> <span class="fu">mean</span>(avg))<span class="sc">/</span><span class="fu">sd</span>(avg)), </span>
<span id="cb80-16"><a href="heterogeneous-treatment-effect-1.html#cb80-16" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># We will order based on how much variation is &#39;explain&#39; by the averages</span></span>
<span id="cb80-17"><a href="heterogeneous-treatment-effect-1.html#cb80-17" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># relative to the total variation of the covariate in the data</span></span>
<span id="cb80-18"><a href="heterogeneous-treatment-effect-1.html#cb80-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">variation=</span><span class="fu">sd</span>(avg) <span class="sc">/</span> <span class="fu">sd</span>(data[,covariate]),</span>
<span id="cb80-19"><a href="heterogeneous-treatment-effect-1.html#cb80-19" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># String to print in each cell in heatmap below</span></span>
<span id="cb80-20"><a href="heterogeneous-treatment-effect-1.html#cb80-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">labels=</span><span class="fu">paste0</span>(<span class="fu">signif</span>(avg, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;(&quot;</span>, <span class="fu">signif</span>(stderr, <span class="dv">3</span>), <span class="st">&quot;)&quot;</span>))</span>
<span id="cb80-21"><a href="heterogeneous-treatment-effect-1.html#cb80-21" aria-hidden="true" tabindex="-1"></a>}, covariates, <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb80-22"><a href="heterogeneous-treatment-effect-1.html#cb80-22" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, df)</span>
<span id="cb80-23"><a href="heterogeneous-treatment-effect-1.html#cb80-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-24"><a href="heterogeneous-treatment-effect-1.html#cb80-24" aria-hidden="true" tabindex="-1"></a><span class="co"># a small optional trick to ensure heatmap will be in decreasing order of &#39;variation&#39;</span></span>
<span id="cb80-25"><a href="heterogeneous-treatment-effect-1.html#cb80-25" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>covariate <span class="ot">&lt;-</span> <span class="fu">reorder</span>(df<span class="sc">$</span>covariate, <span class="fu">order</span>(df<span class="sc">$</span>variation))</span>
<span id="cb80-26"><a href="heterogeneous-treatment-effect-1.html#cb80-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-27"><a href="heterogeneous-treatment-effect-1.html#cb80-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot heatmap</span></span>
<span id="cb80-28"><a href="heterogeneous-treatment-effect-1.html#cb80-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb80-29"><a href="heterogeneous-treatment-effect-1.html#cb80-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(ranking, covariate) <span class="sc">+</span></span>
<span id="cb80-30"><a href="heterogeneous-treatment-effect-1.html#cb80-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> scaling)) <span class="sc">+</span> </span>
<span id="cb80-31"><a href="heterogeneous-treatment-effect-1.html#cb80-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> labels)) <span class="sc">+</span></span>
<span id="cb80-32"><a href="heterogeneous-treatment-effect-1.html#cb80-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">&quot;#E1BE6A&quot;</span>, <span class="at">high =</span> <span class="st">&quot;#40B0A6&quot;</span>) <span class="sc">+</span></span>
<span id="cb80-33"><a href="heterogeneous-treatment-effect-1.html#cb80-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&quot;Average covariate values within group (based on CATE estimate ranking)&quot;</span>)) <span class="sc">+</span></span>
<span id="cb80-34"><a href="heterogeneous-treatment-effect-1.html#cb80-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb80-35"><a href="heterogeneous-treatment-effect-1.html#cb80-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;CATE estimate ranking&quot;</span>) <span class="sc">+</span></span>
<span id="cb80-36"><a href="heterogeneous-treatment-effect-1.html#cb80-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb80-37"><a href="heterogeneous-treatment-effect-1.html#cb80-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>)) </span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-43-1.png" width="672" /></p>
<p>上のヒートマップを解釈する。処置効果の推定値が大きいようなサブグループをあらわしているような共変量は何か。ランキングごとに単調に増加するような共変量はあるか？</p>
<p><font size=1> Interpret the heatmap above. What describes the subgroups
with strongest and weakest estimated treatment effect? Are there
variables that seem to increase or decrease monotonically across
rankings? </font></p>
</div>
<div id="best-linear-projection" class="section level4" number="6.2.2.2">
<h4><span class="header-section-number">6.2.2.2</span> Best linear projection</h4>
<p><code>grf::best_linear_projectoin</code>関数は、Doubly
robustな処置効果の共変量への線形モデルでのフィットを行う。この回帰の係数は一般的なトレンドを示しているが、部分効果として解釈されるべきではない。処置効果と共変量の真の関係性が実際に線形であれば良いが、一般的にそれを仮定するべきではない。</p>
<p>This function provides a doubly robust fit to the linear model
<span class="math inline">\(\widehat{\tau}(X_i) = \beta_0 + A_i&#39;\beta_1\)</span>, where <span class="math inline">\(A_i\)</span> can be a
subset of the covariate columns. The coefficients in this regression are
suggestive of general trends, but they should not be interpret as
partial effects – that would only be true if the true model were really
linear in covariates, and that’s an assumption we shouldn’t be willing
to make in general.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="heterogeneous-treatment-effect-1.html#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Best linear projection of the conditional average treatment effect on covariates</span></span>
<span id="cb81-2"><a href="heterogeneous-treatment-effect-1.html#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">best_linear_projection</span>(forest.tau, X)</span></code></pre></div>
<pre><code>## 
## Best linear projection of the conditional average treatment effect.
## Confidence intervals are cluster- and heteroskedasticity-robust (HC3):
## 
##                Estimate  Std. Error  t value  Pr(&gt;|t|)    
## (Intercept) -0.17904089  0.04251023  -4.2117 2.542e-05 ***
## age          0.00147085  0.00031083   4.7321 2.233e-06 ***
## polviews    -0.03546196  0.00356709  -9.9414 &lt; 2.2e-16 ***
## income      -0.02105844  0.00201947 -10.4277 &lt; 2.2e-16 ***
## educ         0.00894557  0.00172605   5.1827 2.202e-07 ***
## marital      0.01047681  0.00331717   3.1584  0.001588 ** 
## sex         -0.00600787  0.01001081  -0.6001  0.548419    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
<div id="assessing-heterogeneity" class="section level4" number="6.2.2.3">
<h4><span class="header-section-number">6.2.2.3</span> Assessing heterogeneity</h4>
<p><code>test_calibration</code>関数は、Best linear
predictorのCATEをout-of-bag推定による推定値を返す。これを実施すると以下の線形モデルのようになる。（メモ：m(X)がおそらく</p>
<p>The function <code>test_calibration</code> computes an estimate of the best linear
predictor of true CATE based on out-of-bag predictions
<span class="math inline">\(\hat{\tau}^{-i}(\cdot)\)</span>. The exact implementation seeks to fit the
following linear model:</p>
<p><span class="math display">\[
\begin{equation}
Y_{i} - \hat{m}^{-i}(X_{i}) = \alpha\bar{\tau}\left(W_{i} - \hat{e}^{-i}(X_{i})\right) + \beta \left(\hat{\tau}^{-i}(X_{i}) - \bar{\tau} \right) \left(W_{i} - \hat{e}^{-i}(X_{i}) \right) + \epsilon,
\end{equation}
\]</span></p>
<p>係数αとベータは推定値の性能を評価することとなる。αが１であれば、平均的な予測は正しいこととなる。一方で、βが１となれば、Forestによる予測は実際の異質性をとらえていることとなる。</p>
<p>βはCATE予測が真のCATEに伴いどれだけ変わるかをあらわしている。したがって、p値は異質性があるかどうかのオムニバステストのようにもなる。この推定値が0より優位に大きければ、異質性がないという帰無仮説を棄却することができる。しかし、推定値がゼロより小さいことはあまり意味がなく、解釈できない。</p>
<p>where <span class="math inline">\(\bar{\tau} := n^{-1}\sum_{i=1}^{n} \hat{\tau}^{-i}(X_{i})\)</span>. The
coefficients <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> allow us to evaluate the performance
of our estimates. If <span class="math inline">\(\alpha = 1\)</span>, then the average prediction produced
by the forest is correct. Meanwhile, if <span class="math inline">\(\beta = 1\)</span>, then the forest
predictions adequately capture the underlying heterogeneity.</p>
<p>The slope <span class="math inline">\(\beta\)</span> is a measure of how the CATE predictions covary with
true CATE. Therefore, the p-value on the estimate of coefficient also
acts as an omnibus test for the presence of heterogeneity. If the
coefficient is significantly greater than zero, then we can reject the
null of no heterogeneity. However, coefficients smaller than 0 are not
meaningful and show not be interpreted.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="heterogeneous-treatment-effect-1.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_calibration</span>(forest.tau)</span></code></pre></div>
<pre><code>## 
## Best linear fit using forest predictions (on held-out data)
## as well as the mean forest prediction as regressors, along
## with one-sided heteroskedasticity-robust (HC3) SEs:
## 
##                                Estimate Std. Error t value    Pr(&gt;t)    
## mean.forest.prediction         1.001339   0.013712  73.029 &lt; 2.2e-16 ***
## differential.forest.prediction 0.908107   0.048056  18.897 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p><font size=1> Interpret the test above. Is the forest producing correct
estimate of the average treatment effect? Is it capturing the underlying
heterogeneity? </font></p>
</div>
<div id="partial-dependence" class="section level4" number="6.2.2.4">
<h4><span class="header-section-number">6.2.2.4</span> Partial dependence</h4>
<p>他の変数はすべて固定したうえで、一つの変数のみを変えた場合に、CATEの推定値がどのようになるか、という点も興味深いだろう。以下のプロットでは、他の変数をすべてメディアんに固定した上で、関心のある変数を分位点にわたって評価する。</p>
<p>重要なのは、メディアんに固定することで、データポイントが少ないもしくは全く存在しないような領域でCATEを評価してしまうかもしれない。また、一部の変数を固定した上でその他の変数を動かすのはあまり面白くないかもしれにあ。</p>
<p>以下では、<code>causal_forest</code>予測を再び行い、今度は分散の推定も行う。<code>estimate.variances=TRUE</code>とすることで、漸近分散を得ることができる。grfは漸近正規性を持つため、信頼区間も構築することができる。（メモ：他のXは固定した上で、ある関心のあるXに対するτの信頼区間ということか。）</p>
<p>It may also be interesting to examine how our CATE estimates behave when
we change a single covariate, while keeping all the other covariates at
a some fixed value. In the plot below we evaluate a variable of interest
across quantiles, while keeping all other covariates at their median.</p>
<p>It is important to recognize that by keeping some variables at their
median we may be evaluating the CATE at <span class="math inline">\(x\)</span> values in regions where
there are few or no data points. Also, it may be the case that varying
some particular variable while keeping others fixed may just not be very
interesting.</p>
<p>In what follows we’ll again use <code>causal_forest</code> predictions, along with
their variance estimates (set <code>estimate.variances=TRUE</code> when predicting
to we get estimates of the asymptotic variance of the prediction for
each point). Since <code>grf</code> predictions are asymptotically normal, we can
construct 95% confidence intervals in the usual manner (i.e.,
<span class="math inline">\(\hat{\tau}(x) \pm 1.96\sqrt{\widehat{\text{Var}}(\hat{\tau}(x))}\)</span>).</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="heterogeneous-treatment-effect-1.html#cb85-1" aria-hidden="true" tabindex="-1"></a>selected.covariate <span class="ot">&lt;-</span> <span class="st">&quot;polviews&quot;</span></span>
<span id="cb85-2"><a href="heterogeneous-treatment-effect-1.html#cb85-2" aria-hidden="true" tabindex="-1"></a>other.covariates <span class="ot">&lt;-</span> covariates[<span class="fu">which</span>(covariates <span class="sc">!=</span> selected.covariate)]</span>
<span id="cb85-3"><a href="heterogeneous-treatment-effect-1.html#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="heterogeneous-treatment-effect-1.html#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a forest </span></span>
<span id="cb85-5"><a href="heterogeneous-treatment-effect-1.html#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co"># (commented for convenience; no need re-fit if already fitted above)</span></span>
<span id="cb85-6"><a href="heterogeneous-treatment-effect-1.html#cb85-6" aria-hidden="true" tabindex="-1"></a>fmla <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~ 0 + &quot;</span>, <span class="fu">paste0</span>(covariates, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)))</span>
<span id="cb85-7"><a href="heterogeneous-treatment-effect-1.html#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: For smaller confidence intervals, set num.trees ~ sample size</span></span>
<span id="cb85-8"><a href="heterogeneous-treatment-effect-1.html#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="co"># X &lt;- model.matrix(fmla, data)</span></span>
<span id="cb85-9"><a href="heterogeneous-treatment-effect-1.html#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="co"># W &lt;- data[,treatment]</span></span>
<span id="cb85-10"><a href="heterogeneous-treatment-effect-1.html#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Y &lt;- data[,outcome]</span></span>
<span id="cb85-11"><a href="heterogeneous-treatment-effect-1.html#cb85-11" aria-hidden="true" tabindex="-1"></a><span class="co"># forest.tau &lt;- causal_forest(X, Y, W, W.hat=.5)  # few trees for speed here</span></span>
<span id="cb85-12"><a href="heterogeneous-treatment-effect-1.html#cb85-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-13"><a href="heterogeneous-treatment-effect-1.html#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute a grid of values appropriate for the selected covariate</span></span>
<span id="cb85-14"><a href="heterogeneous-treatment-effect-1.html#cb85-14" aria-hidden="true" tabindex="-1"></a>grid.size <span class="ot">&lt;-</span> <span class="dv">7</span> </span>
<span id="cb85-15"><a href="heterogeneous-treatment-effect-1.html#cb85-15" aria-hidden="true" tabindex="-1"></a>covariate.grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(data[,selected.covariate]), <span class="fu">max</span>(data[,selected.covariate]), <span class="at">length.out=</span>grid.size)</span>
<span id="cb85-16"><a href="heterogeneous-treatment-effect-1.html#cb85-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-17"><a href="heterogeneous-treatment-effect-1.html#cb85-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Other options for constructing a grid:</span></span>
<span id="cb85-18"><a href="heterogeneous-treatment-effect-1.html#cb85-18" aria-hidden="true" tabindex="-1"></a><span class="co"># For a binary variable, simply use 0 and 1</span></span>
<span id="cb85-19"><a href="heterogeneous-treatment-effect-1.html#cb85-19" aria-hidden="true" tabindex="-1"></a><span class="co"># grid.size &lt;- 2</span></span>
<span id="cb85-20"><a href="heterogeneous-treatment-effect-1.html#cb85-20" aria-hidden="true" tabindex="-1"></a><span class="co"># covariate.grid &lt;- c(0, 1)  </span></span>
<span id="cb85-21"><a href="heterogeneous-treatment-effect-1.html#cb85-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-22"><a href="heterogeneous-treatment-effect-1.html#cb85-22" aria-hidden="true" tabindex="-1"></a><span class="co"># For a continuous variable, select appropriate percentiles</span></span>
<span id="cb85-23"><a href="heterogeneous-treatment-effect-1.html#cb85-23" aria-hidden="true" tabindex="-1"></a><span class="co"># percentiles &lt;- c(.1, .25, .5, .75, .9)</span></span>
<span id="cb85-24"><a href="heterogeneous-treatment-effect-1.html#cb85-24" aria-hidden="true" tabindex="-1"></a><span class="co"># grid.size &lt;- length(percentiles)</span></span>
<span id="cb85-25"><a href="heterogeneous-treatment-effect-1.html#cb85-25" aria-hidden="true" tabindex="-1"></a><span class="co"># covariate.grid &lt;- quantile(data[,selected.covariate], probs=percentiles)</span></span>
<span id="cb85-26"><a href="heterogeneous-treatment-effect-1.html#cb85-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-27"><a href="heterogeneous-treatment-effect-1.html#cb85-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Take median of other covariates </span></span>
<span id="cb85-28"><a href="heterogeneous-treatment-effect-1.html#cb85-28" aria-hidden="true" tabindex="-1"></a>medians <span class="ot">&lt;-</span> <span class="fu">apply</span>(data[, other.covariates, F], <span class="dv">2</span>, median)</span>
<span id="cb85-29"><a href="heterogeneous-treatment-effect-1.html#cb85-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-30"><a href="heterogeneous-treatment-effect-1.html#cb85-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a dataset</span></span>
<span id="cb85-31"><a href="heterogeneous-treatment-effect-1.html#cb85-31" aria-hidden="true" tabindex="-1"></a>data.grid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">sapply</span>(medians, <span class="cf">function</span>(x) <span class="fu">rep</span>(x, grid.size)), covariate.grid)</span>
<span id="cb85-32"><a href="heterogeneous-treatment-effect-1.html#cb85-32" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data.grid) <span class="ot">&lt;-</span> <span class="fu">c</span>(other.covariates, selected.covariate)</span>
<span id="cb85-33"><a href="heterogeneous-treatment-effect-1.html#cb85-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-34"><a href="heterogeneous-treatment-effect-1.html#cb85-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Expand the data</span></span>
<span id="cb85-35"><a href="heterogeneous-treatment-effect-1.html#cb85-35" aria-hidden="true" tabindex="-1"></a>X.grid <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla, data.grid)</span>
<span id="cb85-36"><a href="heterogeneous-treatment-effect-1.html#cb85-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-37"><a href="heterogeneous-treatment-effect-1.html#cb85-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Point predictions of the CATE and standard errors </span></span>
<span id="cb85-38"><a href="heterogeneous-treatment-effect-1.html#cb85-38" aria-hidden="true" tabindex="-1"></a>forest.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest.tau, <span class="at">newdata =</span> X.grid, <span class="at">estimate.variance=</span><span class="cn">TRUE</span>)</span>
<span id="cb85-39"><a href="heterogeneous-treatment-effect-1.html#cb85-39" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> forest.pred<span class="sc">$</span>predictions</span>
<span id="cb85-40"><a href="heterogeneous-treatment-effect-1.html#cb85-40" aria-hidden="true" tabindex="-1"></a>tau.hat.se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(forest.pred<span class="sc">$</span>variance.estimates)</span>
<span id="cb85-41"><a href="heterogeneous-treatment-effect-1.html#cb85-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-42"><a href="heterogeneous-treatment-effect-1.html#cb85-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot predictions for each group and 95% confidence intervals around them.</span></span>
<span id="cb85-43"><a href="heterogeneous-treatment-effect-1.html#cb85-43" aria-hidden="true" tabindex="-1"></a>data.pred <span class="ot">&lt;-</span> <span class="fu">transform</span>(data.grid, <span class="at">tau.hat=</span>tau.hat, <span class="at">ci.low =</span> tau.hat <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>tau.hat.se, <span class="at">ci.high =</span> tau.hat <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>tau.hat.se)</span>
<span id="cb85-44"><a href="heterogeneous-treatment-effect-1.html#cb85-44" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data.pred) <span class="sc">+</span></span>
<span id="cb85-45"><a href="heterogeneous-treatment-effect-1.html#cb85-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes_string</span>(<span class="at">x=</span>selected.covariate, <span class="at">y=</span><span class="st">&quot;tau.hat&quot;</span>, <span class="at">group =</span> <span class="dv">1</span>), <span class="at">color=</span><span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb85-46"><a href="heterogeneous-treatment-effect-1.html#cb85-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes_string</span>(<span class="at">x=</span>selected.covariate, <span class="at">ymin=</span><span class="st">&quot;ci.low&quot;</span>, <span class="at">ymax=</span><span class="st">&quot;ci.high&quot;</span>, <span class="at">width=</span>.<span class="dv">2</span>), <span class="at">color=</span><span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb85-47"><a href="heterogeneous-treatment-effect-1.html#cb85-47" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb85-48"><a href="heterogeneous-treatment-effect-1.html#cb85-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&quot;Predicted treatment effect varying &#39;&quot;</span>, selected.covariate, <span class="st">&quot;&#39; (other variables fixed at median)&quot;</span>)) <span class="sc">+</span></span>
<span id="cb85-49"><a href="heterogeneous-treatment-effect-1.html#cb85-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">&quot;polviews&quot;</span>, <span class="at">breaks=</span>covariate.grid, <span class="at">labels=</span><span class="fu">signif</span>(covariate.grid, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb85-50"><a href="heterogeneous-treatment-effect-1.html#cb85-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb85-51"><a href="heterogeneous-treatment-effect-1.html#cb85-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)) </span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-46-1.png" width="672" /></p>
<p>この例では、かなり大きな信頼区間となっている点に注意せよ。これは2つの観点から説明できる。まず、上で言及したように、データが少ない問題がある。例えば、polviewsが６であるようなデータ自体は少なくないにもかかわらず（以下のコードを走らせると全サンプルの15%は６である。）、</p>
<p>Note that, in this example, we got fairly large confidence intervals.
This can be explained in two ways. First, as we mentioned above, there’s
a data scarcity problem. For example, even though the number of
observations with <code>polviews</code> equal to <code>6</code> is not small,</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="heterogeneous-treatment-effect-1.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(data, <span class="fu">mean</span>(polviews <span class="sc">==</span> <span class="dv">6</span>))</span></code></pre></div>
<pre><code>## [1] 0.1545388</code></pre>
<p>polviewが６であり、かつ、例えば年齢がメディアンに近いような人の数は遥かに少なくなってしまうし、</p>
<p>there’s a much smaller fraction of individuals with <code>polviews</code> equal to
<code>6</code> and (say) age close to the median age,</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="heterogeneous-treatment-effect-1.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">with</span>(data, (polviews <span class="sc">==</span> <span class="dv">6</span>) <span class="sc">&amp;</span> (<span class="fu">abs</span>(age <span class="sc">-</span> <span class="fu">median</span>(age)) <span class="sc">&lt;=</span> <span class="dv">3</span>))) <span class="co"># at most 3 yrs away</span></span></code></pre></div>
<pre><code>## [1] 0.02247583</code></pre>
<p>さらに他の変数までメディアンに近いような人はさらに少なくなってしまう。２つ目の理由は、統計的な問題である。grfはノンパラモデルのため、比較的大きな信頼区間が構築される。特に高次元の問題の場合には顕著である。モデリングの仮定を避けたために生じる問題であり（パラメトリックな仮定をおかなかったから）、これは避けられない結果である。</p>
<blockquote>
<p>and an even smaller fraction of observations with <code>polviews</code> equal to
<code>6</code> and every other variable close to the median. The second cause of
wide confidence intervals is statistical. Since <code>grf</code> is a
non-parametric model, we should expect fairly wide confidence
intervals, especially in high-dimensional problems – that is an
unavoidable consequence of avoiding modeling assumptions.</p>
</blockquote>
<p>GRFの元論文でも指摘されているように、grfの信頼区間のカバレッジ範囲は、サンプル数に比較してシグナルが強すぎるか複雑すぎる場合において低下する。また、木の数を増やすことによってより狭い信頼区間を構築することが可能である。詳細はshort
vignetteを参照せよ。</p>
<blockquote>
<p><font size=2> As documented in the original paper on generalized
random forests (<a href="https://arxiv.org/abs/1610.01271">Athey, Tibshirani and Wager,
2019</a>), the coverage of <code>grf</code>
confidence intervals can drop if the signal is too dense or too
complex relative to the number of observations. Also, to a point, it’s
possible to get tighter confidence intervals by increasing the number
of trees; see this <a href="https://grf-labs.github.io/grf/articles/ci_and_num.trees.html">short
vignette</a>
for more information. </font></p>
</blockquote>
<p>2つ以上の変数を同時に動かすことも可能である。以下のコードは、2つの変数を動かして得られた推定値と標準誤差である。</p>
<p>We can vary more than one variable at a time. The next snippet shows
predictions and standard errors varying two variables.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="heterogeneous-treatment-effect-1.html#cb90-1" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="st">&#39;polviews&#39;</span></span>
<span id="cb90-2"><a href="heterogeneous-treatment-effect-1.html#cb90-2" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="st">&#39;age&#39;</span></span>
<span id="cb90-3"><a href="heterogeneous-treatment-effect-1.html#cb90-3" aria-hidden="true" tabindex="-1"></a>selected.covariates <span class="ot">&lt;-</span> <span class="fu">c</span>(x1, x2)</span>
<span id="cb90-4"><a href="heterogeneous-treatment-effect-1.html#cb90-4" aria-hidden="true" tabindex="-1"></a>other.covariates <span class="ot">&lt;-</span> covariates[<span class="sc">-</span><span class="fu">which</span>(covariates <span class="sc">%in%</span> selected.covariates)]</span>
<span id="cb90-5"><a href="heterogeneous-treatment-effect-1.html#cb90-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-6"><a href="heterogeneous-treatment-effect-1.html#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute a grid of values appropriate for the selected covariate</span></span>
<span id="cb90-7"><a href="heterogeneous-treatment-effect-1.html#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="co"># See other options for constructing grids in the snippet above.</span></span>
<span id="cb90-8"><a href="heterogeneous-treatment-effect-1.html#cb90-8" aria-hidden="true" tabindex="-1"></a>x1.grid.size <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb90-9"><a href="heterogeneous-treatment-effect-1.html#cb90-9" aria-hidden="true" tabindex="-1"></a>x2.grid.size <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb90-10"><a href="heterogeneous-treatment-effect-1.html#cb90-10" aria-hidden="true" tabindex="-1"></a>x1.grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(data[,x1]), <span class="fu">max</span>(data[,x1]), <span class="at">length.out=</span>x1.grid.size)</span>
<span id="cb90-11"><a href="heterogeneous-treatment-effect-1.html#cb90-11" aria-hidden="true" tabindex="-1"></a>x2.grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(data[,x2]), <span class="fu">max</span>(data[,x2]), <span class="at">length.out=</span>x2.grid.size)</span>
<span id="cb90-12"><a href="heterogeneous-treatment-effect-1.html#cb90-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-13"><a href="heterogeneous-treatment-effect-1.html#cb90-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Take median of other covariates </span></span>
<span id="cb90-14"><a href="heterogeneous-treatment-effect-1.html#cb90-14" aria-hidden="true" tabindex="-1"></a>medians <span class="ot">&lt;-</span> <span class="fu">apply</span>(data[, other.covariates, F], <span class="dv">2</span>, median)</span>
<span id="cb90-15"><a href="heterogeneous-treatment-effect-1.html#cb90-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-16"><a href="heterogeneous-treatment-effect-1.html#cb90-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct dataset</span></span>
<span id="cb90-17"><a href="heterogeneous-treatment-effect-1.html#cb90-17" aria-hidden="true" tabindex="-1"></a>data.grid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb90-18"><a href="heterogeneous-treatment-effect-1.html#cb90-18" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sapply</span>(medians, <span class="cf">function</span>(x) <span class="fu">rep</span>(x, grid.size)), </span>
<span id="cb90-19"><a href="heterogeneous-treatment-effect-1.html#cb90-19" aria-hidden="true" tabindex="-1"></a>                <span class="fu">expand.grid</span>(x1.grid, x2.grid))</span>
<span id="cb90-20"><a href="heterogeneous-treatment-effect-1.html#cb90-20" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data.grid) <span class="ot">&lt;-</span> <span class="fu">c</span>(other.covariates, selected.covariates)</span>
<span id="cb90-21"><a href="heterogeneous-treatment-effect-1.html#cb90-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-22"><a href="heterogeneous-treatment-effect-1.html#cb90-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Expand the data according to formula used to fit forest</span></span>
<span id="cb90-23"><a href="heterogeneous-treatment-effect-1.html#cb90-23" aria-hidden="true" tabindex="-1"></a>X.grid <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(fmla, data.grid)</span>
<span id="cb90-24"><a href="heterogeneous-treatment-effect-1.html#cb90-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-25"><a href="heterogeneous-treatment-effect-1.html#cb90-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Forest-based point estimates of CATE and standard errors around them</span></span>
<span id="cb90-26"><a href="heterogeneous-treatment-effect-1.html#cb90-26" aria-hidden="true" tabindex="-1"></a>forest.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(forest.tau, <span class="at">newdata =</span> X.grid, <span class="at">estimate.variance=</span><span class="cn">TRUE</span>)</span>
<span id="cb90-27"><a href="heterogeneous-treatment-effect-1.html#cb90-27" aria-hidden="true" tabindex="-1"></a>tau.hat <span class="ot">&lt;-</span> forest.pred<span class="sc">$</span>predictions</span>
<span id="cb90-28"><a href="heterogeneous-treatment-effect-1.html#cb90-28" aria-hidden="true" tabindex="-1"></a>tau.hat.se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(forest.pred<span class="sc">$</span>variance.estimates)</span>
<span id="cb90-29"><a href="heterogeneous-treatment-effect-1.html#cb90-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-30"><a href="heterogeneous-treatment-effect-1.html#cb90-30" aria-hidden="true" tabindex="-1"></a><span class="co"># A vector of labels for plotting below</span></span>
<span id="cb90-31"><a href="heterogeneous-treatment-effect-1.html#cb90-31" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> <span class="fu">mapply</span>(<span class="cf">function</span>(est, se) <span class="fu">paste0</span>(<span class="fu">signif</span>(est, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="st">&quot;(&quot;</span>, <span class="fu">signif</span>(se, <span class="dv">3</span>), <span class="st">&quot;)&quot;</span>), tau.hat, tau.hat.se)</span>
<span id="cb90-32"><a href="heterogeneous-treatment-effect-1.html#cb90-32" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(X.grid, tau.hat, labels)</span>
<span id="cb90-33"><a href="heterogeneous-treatment-effect-1.html#cb90-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-34"><a href="heterogeneous-treatment-effect-1.html#cb90-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting</span></span>
<span id="cb90-35"><a href="heterogeneous-treatment-effect-1.html#cb90-35" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb90-36"><a href="heterogeneous-treatment-effect-1.html#cb90-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(age, polviews) <span class="sc">+</span></span>
<span id="cb90-37"><a href="heterogeneous-treatment-effect-1.html#cb90-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> tau.hat)) <span class="sc">+</span> </span>
<span id="cb90-38"><a href="heterogeneous-treatment-effect-1.html#cb90-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> labels)) <span class="sc">+</span></span>
<span id="cb90-39"><a href="heterogeneous-treatment-effect-1.html#cb90-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">high =</span> <span class="st">&quot;orange&quot;</span>) <span class="sc">+</span></span>
<span id="cb90-40"><a href="heterogeneous-treatment-effect-1.html#cb90-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;polviews&quot;</span>, <span class="at">breaks=</span>x1.grid, <span class="at">labels=</span><span class="fu">signif</span>(x1.grid, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb90-41"><a href="heterogeneous-treatment-effect-1.html#cb90-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">&quot;age&quot;</span>, <span class="at">breaks=</span>x2.grid, <span class="at">labels=</span><span class="fu">signif</span>(x2.grid, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb90-42"><a href="heterogeneous-treatment-effect-1.html#cb90-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&quot;Predicted treatment effect varying &#39;&quot;</span>, x1, <span class="st">&quot;&#39; and &#39;&quot;</span>, x2, <span class="st">&quot;&#39; (other variables fixed at median)&quot;</span>)) <span class="sc">+</span></span>
<span id="cb90-43"><a href="heterogeneous-treatment-effect-1.html#cb90-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb90-44"><a href="heterogeneous-treatment-effect-1.html#cb90-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)) </span></code></pre></div>
<p><img src="book_filename_files/figure-html/unnamed-chunk-49-1.png" width="672" /></p>
</div>
</div>
<div id="実際の活用におけるプロセス" class="section level3" number="6.2.3">
<h3><span class="header-section-number">6.2.3</span> 実際の活用におけるプロセス</h3>
<ul>
<li><p>ＧＲＦの活用に際して、ここではPre-specified
hypothesisではなく、あくまでPostでの検討を考える。</p></li>
<li><p>まずはすべての変数（共変量）を使ってGRFにフィットさせる。</p></li>
<li><p>変数重要度を見ること。また、処置効果別の5分位点で比較してみること。、分位別の共変量の違いを観察することを行うべきである。</p></li>
</ul>
</div>
</div>
<div id="further-reading" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> Further reading</h2>
<p>A readable summary of different method for hypothesis testing correction
is laid out in the introduction to <a href="http://ftp.iza.org/dp12845.pdf">Clarke, Romano and Wolf
(2009)</a>.</p>
<p><a href="https://arxiv.org/abs/1902.07409">Athey and Wager (2019)</a> shows an
application of causal forests to heterogeity analysis in a setting with
clustering.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="04-literature.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="IPW.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/heterogeneous-treatment-effect-1.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
